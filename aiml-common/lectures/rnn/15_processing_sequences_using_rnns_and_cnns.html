

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Processing Sequences Using RNN &#8212; Introduction to Artificial Intelligence</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Vibur" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jupyterlite_sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../../../_static/tabs.js"></script>
    <script src="../../../_static/jupyterlite_sphinx.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns';</script>
    <link rel="canonical" href="https://pantelis.github.io/artificial-intelligence/aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Introduction to NLP" href="../nlp/nlp-intro/_index.html" />
    <link rel="prev" title="The Long Short-Term Memory (LSTM) Cell Architecture" href="lstm/_index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Introduction to Artificial Intelligence
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Syllabus</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../syllabus/_index.html">Syllabus</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to AI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ai-intro/course-introduction/_index.html">Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ai-intro/data-science-360/_index.html">Data Science 360</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ai-intro/systems-approach/_index.html">The four approaches towards AI</a></li>

<li class="toctree-l1"><a class="reference internal" href="../ai-intro/agents/_index.html">Agent-Environment Interface</a></li>



<li class="toctree-l1"><a class="reference internal" href="../ai-intro/pipelines/_index.html">ML Pipelines</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The Learning Problem</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../learning-problem/_index.html">The Learning Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regression/linear-regression/linear_regression.html">Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/sgd/_index.html">Stochastic Gradient Descent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../entropy/_index.html">Entropy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/maximum-likelihood/marginal_maximum_likelihood.html">Maximum Likelihood Estimation of a marginal model</a></li>

<li class="toctree-l1"><a class="reference internal" href="../optimization/maximum-likelihood/conditional_maximum_likelihood.html">Maximum Likelihood (ML) Estimation of conditional models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../classification/classification-intro/_index.html">Introduction to Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../classification/logistic-regression/_index.html">Logistic Regression</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bayesian Inference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pgm/bayesian-inference/_index.html">Bayesian Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/bayesian-inference/bayesian_regression.html">Bayesian Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/bayesian-coin/bayesian_update_coin_flip.html">Posterior updates in a coin flipping experiment</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Deep Neural Networks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../classification/perceptron/_index.html">The Neuron (Perceptron)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dnn/dnn-intro/_index.html">Deep Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dnn/backprop-intro/_index.html">Introduction to Backpropagation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dnn/backprop-dnn/_index.html">Backpropagation in Deep Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dnn/backprop-dnn-exercises/_index.html">Backpropagation DNN exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dnn/fashion-mnist-case-study.html">Fashion MNIST Case Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/regularization/_index.html">Regularization in Deep Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/regularization/regularization-workshop-1.html">Regularization Workshop</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Convolutional Neural Networks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../cnn/cnn-intro/_index.html">Introduction to Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cnn/cnn-layers/_index.html">CNN Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cnn/cnn-example-architectures/_index.html">CNN Example Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cnn/cnn-example-architectures/using_convnets_with_small_datasets.html">Using convnets with small datasets</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Transfer Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../transfer-learning/transfer-learning-introduction.html">Introduction to Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transfer-learning/transfer_learning_tutorial.html">Transfer Learning for Computer Vision Tutorial</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Scene Understanding</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../scene-understanding/scene-understanding-intro/index.html">Introduction to Scene Understanding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scene-understanding/feature-extraction-resnet/index.html">Feature Extraction via Residual Networks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scene-understanding/object-detection/object-detection-intro/index.html">Object Detection</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/object-detection/detection-metrics/index.html">Object Detection and Semantic Segmentation Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/object-detection/rcnn-object-detection/index.html">Region-CNN (RCNN) Object Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/object-detection/faster-rcnn-object-detection/index.html">Fast and Faster RCNN Object Detection</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scene-understanding/semantic-segmentation/index.html">Semantic Segmentation</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/index.html">Mask R-CNN Semantic Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/demo.html">Mask R-CNN Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_data.html">Mask R-CNN - Inspect Training Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.html">Mask R-CNN - Inspect Trained Model</a></li>










<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_weights.html">Mask R-CNN - Inspect Weights of a Trained Model</a></li>





<li class="toctree-l2"><a class="reference internal" href="../scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/detectron2_tutorial.html">Detectron2 Beginner’s Tutorial</a></li>





</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Probabilistic Reasoning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pgm/pgm-intro/_index.html">Introduction to Probabilistic Reasoning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/recursive-state-estimation/_index.html">Recursive State Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/bayesian-filter-workshop/_index.html">Bayesian Filter Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/hmm-localization/_index.html">Localization and Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pgm/kalman-workshop/_index.html">Kalman Filter Workshop</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Logical Reasoning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../logical-reasoning/automated-reasoning/_index.html">Automated Reasoning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logical-reasoning/propositional-logic/_index.html">World Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logical-reasoning/logical-agents/_index.html">Logical Agents</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Planning without Interactions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../planning/_index.html">Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autonomous-cars/_index.html">Autonomous Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autonomous-cars/imitation-learning/_index.html">Imitation Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../planning/classical-planning/_index.html">Classical Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../planning/search/_index.html">Planning with Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../planning/search/forward-search/_index.html">Forward Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../planning/search/a-star/_index.html">The A* Algorithm</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Markov Decision Processes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../mdp/_index.html">Markov Decision Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mdp/mdp-intro/_index.html">Introduction to MDP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mdp/bellman-expectation-backup/_index.html">Bellman Expectation Backup</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mdp/bellman-optimality-backup/_index.html">MDP Dynamic Programming Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mdp/mdp-dp-algorithms/policy-iteration/_index.html">Policy Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mdp/mdp-dp-algorithms/policy-evaluation/_index.html">Policy Evaluation (Prediction)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mdp/mdp-dp-algorithms/policy-improvement/_index.html">Policy Improvement (Control)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mdp/mdp-dp-algorithms/value-iteration/_index.html">Value Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mdp/mdp-lab/recycling-robot/_index.html">Finding the optimal policy of a recycling robot.</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reinforcement Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/_index.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/prediction/monte-carlo.html">Monte-Carlo Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/prediction/temporal-difference.html">Temporal Difference (TD) Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/control/_index.html">Model-free Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/generalized-policy-iteration/_index.html">Generalized Policy Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/control/sarsa/_index.html">The SARSA Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reinforcement-learning/reinforce/_index.html">The REINFORCE Algorithm</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Sequences and RNNs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction/_index.html">Introduction to Recurrent Neural Networks (RNN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="simple-rnn/_index.html">Simple RNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="lstm/_index.html">The Long Short-Term Memory (LSTM) Cell Architecture</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Processing Sequences Using RNN</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Natural Language Processing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../nlp/nlp-intro/_index.html">Introduction to NLP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/word2vec/_index.html">Word2Vec Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/word2vec/word2vec-workshop.html">Word2Vec Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/language-models/_index.html">RNN Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/language-models/simple-rnn-language-model.html">Simple RNN Language Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/language-models/cnn-language-model.html">CNN Language Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/nmt/_index.html">Neural Machine Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/nmt-metrics/_index.html">NMT Metrics - BLEU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/attention/_index.html">Attention in NMT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/transformers/_index.html">Transformers Workshop</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Math Background</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../ml-math/_index.html">Math for ML</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ml-math/probability/_index.html">Probability Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linear-algebra/_index.html">Linear Algebra for Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ml-math/calculus/_index.html">Calculus</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../resources/environment/index.html">Your Programming Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/environment/assignment-submission.html">Submitting Your Assignment / Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/_index.html">Learn Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/environment/notebook-status.html">Notebook execution status</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Common Assignments</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../assignments/probability/probability-assignment-5/index.html">Probability Assignment</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Assignments CS-UY-4613</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../assignments/mle/mle-gaussian.html">Gaussian Maximum Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../assignments/mle/poisson-regression-1/index.html">Bike Rides and the Poisson Model</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Assignments CS-GY-6613</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../assignments/logistic-regression-1/index.html">Logistic Regression</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/pantelis/artificial-intelligence/master?urlpath=tree/artificial_intelligence/aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/pantelis/artificial-intelligence/blob/master/artificial_intelligence/aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/pantelis/artificial-intelligence" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pantelis/artificial-intelligence/edit/master/artificial_intelligence/aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pantelis/artificial-intelligence/issues/new?title=Issue%20on%20page%20%2Faiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/aiml-common/lectures/rnn/15_processing_sequences_using_rnns_and_cnns.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Processing Sequences Using RNN</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Processing Sequences Using RNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-rnns">Basic RNNs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-dataset">Generate the Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-some-baselines">Computing Some Baselines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-simple-rnn">Using a Simple RNN</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnns">Deep RNNs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-several-steps-ahead">Forecasting Several Steps Ahead</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnn-with-batch-norm">Deep RNN with Batch Norm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnns-with-layer-norm">Deep RNNs with Layer Norm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-custom-rnn-class">Creating a Custom RNN Class</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#lstms">LSTMs</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#grus">GRUs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-one-dimensional-convolutional-layers-to-process-sequences">Using One-Dimensional Convolutional Layers to Process Sequences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wavenet">WaveNet</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-solutions">Exercise solutions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-8">1. to 8.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tackling-the-sketchrnn-dataset">9. Tackling the SketchRNN Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bach-chorales">10. Bach Chorales</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><strong>Chapter 15 – Processing Sequences Using RNNs and CNNs</strong></p>
<p><em>This notebook contains all the sample code in chapter 15.</em></p>
<table align="left">
  <td>
    <a href="https://colab.research.google.com/github/ageron/handson-ml2/blob/master/15_processing_sequences_using_rnns_and_cnns.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a>
  </td>
  <td>
    <a target="_blank" href="https://kaggle.com/kernels/welcome?src=https://github.com/ageron/handson-ml2/blob/master/15_processing_sequences_using_rnns_and_cnns.ipynb"><img src="https://kaggle.com/static/images/open-in-kaggle.svg" /></a>
  </td>
</table><section class="tex2jax_ignore mathjax_ignore" id="processing-sequences-using-rnn">
<h1>Processing Sequences Using RNN<a class="headerlink" href="#processing-sequences-using-rnn" title="Permalink to this headline">#</a></h1>
<p>First, let’s import a few common modules, ensure MatplotLib plots figures inline and prepare a function to save the figures. We also check that Python 3.5 or later is installed (although Python 2.x may work, it is deprecated so we strongly recommend you use Python 3 instead), as well as Scikit-Learn ≥0.20 and TensorFlow ≥2.0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python ≥3.5 is required</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># Is this notebook running on Colab or Kaggle?</span>
<span class="n">IS_COLAB</span> <span class="o">=</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
<span class="n">IS_KAGGLE</span> <span class="o">=</span> <span class="s2">&quot;kaggle_secrets&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>

<span class="c1"># Scikit-Learn ≥0.20 is required</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="k">assert</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s2">&quot;0.20&quot;</span>

<span class="c1"># TensorFlow ≥2.0 is required</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="k">assert</span> <span class="n">tf</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s2">&quot;2.0&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPU was detected. LSTMs and CNNs can be very slow without a GPU.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_COLAB</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Go to Runtime &gt; Change runtime and select a GPU hardware accelerator.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_KAGGLE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Go to Settings &gt; Accelerator and select GPU.&quot;</span><span class="p">)</span>

<span class="c1"># Common imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># to make this notebook&#39;s output stable across runs</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># To plot pretty figures</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Where to save the figures</span>
<span class="n">PROJECT_ROOT_DIR</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">CHAPTER_ID</span> <span class="o">=</span> <span class="s2">&quot;rnn&quot;</span>
<span class="n">IMAGES_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="n">CHAPTER_ID</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">IMAGES_PATH</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_fig</span><span class="p">(</span><span class="n">fig_id</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig_extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMAGES_PATH</span><span class="p">,</span> <span class="n">fig_id</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fig_extension</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving figure&quot;</span><span class="p">,</span> <span class="n">fig_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tight_layout</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fig_extension</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No GPU was detected. LSTMs and CNNs can be very slow without a GPU.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-19 11:04:03.058868: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-03-19 11:04:03.204147: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.10/x64/lib
2023-03-19 11:04:03.204174: I tensorflow/compiler/xla/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
2023-03-19 11:04:04.097339: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.10/x64/lib
2023-03-19 11:04:04.097472: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.10/x64/lib
2023-03-19 11:04:04.097485: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
2023-03-19 11:04:05.625300: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.10/x64/lib
2023-03-19 11:04:05.625354: W tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:265] failed call to cuInit: UNKNOWN ERROR (303)
2023-03-19 11:04:05.625378: I tensorflow/compiler/xla/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az337-145): /proc/driver/nvidia/version does not exist
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="basic-rnns">
<h1>Basic RNNs<a class="headerlink" href="#basic-rnns" title="Permalink to this headline">#</a></h1>
<section id="generate-the-dataset">
<h2>Generate the Dataset<a class="headerlink" href="#generate-the-dataset" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_time_series</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
    <span class="n">freq1</span><span class="p">,</span> <span class="n">freq2</span><span class="p">,</span> <span class="n">offsets1</span><span class="p">,</span> <span class="n">offsets2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">offsets1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">freq1</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1">#   wave 1</span>
    <span class="n">series</span> <span class="o">+=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">offsets2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">freq2</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">20</span><span class="p">))</span> <span class="c1"># + wave 2</span>
    <span class="n">series</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>   <span class="c1"># + noise</span>
    <span class="k">return</span> <span class="n">series</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="mi">7000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[:</span><span class="mi">7000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">9000</span><span class="p">:,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="mi">9000</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((7000, 50, 1), (7000, 1))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="s2">&quot;$t$&quot;</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;$x(t)$&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Prediction&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="ow">or</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    <span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">y_label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;$x(t)$&quot;</span> <span class="k">if</span> <span class="n">col</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">legend</span><span class="o">=</span><span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">save_fig</span><span class="p">(</span><span class="s2">&quot;time_series_plot&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure time_series_plot
</pre></div>
</div>
<img alt="../../../_images/57e097e40f9462b9dbc563772307312ef33cb2670a37f4c68642562c83e64715.png" src="../../../_images/57e097e40f9462b9dbc563772307312ef33cb2670a37f4c68642562c83e64715.png" />
</div>
</div>
<p><strong>Note</strong>: in this notebook, the blue dots represent targets, and red crosses represent predictions. In the book, I first used blue crosses for targets and red dots for predictions, then I reversed this later in the chapter. Sorry if this caused some confusion.</p>
</section>
<section id="computing-some-baselines">
<h2>Computing Some Baselines<a class="headerlink" href="#computing-some-baselines" title="Permalink to this headline">#</a></h2>
<p>Naive predictions (just predict the last observed value):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-03-19 11:04:07.430900: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.020211367
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/5c3130e64e769383eda400876eaed757360a69efd2efc7bd9c0f71c02c441574.png" src="../../../_images/5c3130e64e769383eda400876eaed757360a69efd2efc7bd9c0f71c02c441574.png" />
</div>
</div>
<p>Linear predictions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 1s 3ms/step - loss: 0.1662 - val_loss: 0.0703
Epoch 2/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0423 - val_loss: 0.0283
Epoch 3/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0207 - val_loss: 0.0160
Epoch 4/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0130 - val_loss: 0.0110
Epoch 5/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0096 - val_loss: 0.0087
Epoch 6/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0079 - val_loss: 0.0074
Epoch 7/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0069 - val_loss: 0.0065
Epoch 8/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0062 - val_loss: 0.0059
Epoch 9/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0056 - val_loss: 0.0053
Epoch 10/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0052 - val_loss: 0.0049
Epoch 11/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0049 - val_loss: 0.0046
Epoch 12/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0046 - val_loss: 0.0044
Epoch 13/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0043 - val_loss: 0.0041
Epoch 14/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0042 - val_loss: 0.0040
Epoch 15/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0041 - val_loss: 0.0038
Epoch 16/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0040 - val_loss: 0.0039
Epoch 17/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0039 - val_loss: 0.0037
Epoch 18/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0038 - val_loss: 0.0036
Epoch 19/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0038 - val_loss: 0.0037
Epoch 20/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0037 - val_loss: 0.0036
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 1ms/step - loss: 0.0036
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.003556677605956793
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_learning_curves</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">&quot;b.-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_loss</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="s2">&quot;r.-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Validation loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/1bf96ea2a3e268625e9c6cc3496875f214a46ed8150d82cef42ce0daa87910ec.png" src="../../../_images/1bf96ea2a3e268625e9c6cc3496875f214a46ed8150d82cef42ce0daa87910ec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 1ms/step
</pre></div>
</div>
<img alt="../../../_images/3dc9c4db30cda17c279432b5944c008ee852d1910727308b66e65fdd1634c897.png" src="../../../_images/3dc9c4db30cda17c279432b5944c008ee852d1910727308b66e65fdd1634c897.png" />
</div>
</div>
</section>
<section id="using-a-simple-rnn">
<h2>Using a Simple RNN<a class="headerlink" href="#using-a-simple-rnn" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 3s 9ms/step - loss: 0.7523 - val_loss: 0.4252
Epoch 2/20
219/219 [==============================] - 2s 8ms/step - loss: 0.2458 - val_loss: 0.1555
Epoch 3/20
219/219 [==============================] - 2s 7ms/step - loss: 0.1462 - val_loss: 0.1490
Epoch 4/20
219/219 [==============================] - 2s 7ms/step - loss: 0.1464 - val_loss: 0.1471
Epoch 5/20
219/219 [==============================] - 2s 8ms/step - loss: 0.1482 - val_loss: 0.1524
Epoch 6/20
219/219 [==============================] - 2s 7ms/step - loss: 0.1287 - val_loss: 0.0883
Epoch 7/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0598 - val_loss: 0.0466
Epoch 8/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0384 - val_loss: 0.0338
Epoch 9/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0298 - val_loss: 0.0272
Epoch 10/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0248 - val_loss: 0.0231
Epoch 11/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0215 - val_loss: 0.0201
Epoch 12/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0191 - val_loss: 0.0180
Epoch 13/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0173 - val_loss: 0.0164
Epoch 14/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0159 - val_loss: 0.0150
Epoch 15/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0147 - val_loss: 0.0140
Epoch 16/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0138 - val_loss: 0.0131
Epoch 17/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0131 - val_loss: 0.0125
Epoch 18/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0126 - val_loss: 0.0120
Epoch 19/20
219/219 [==============================] - 2s 8ms/step - loss: 0.0121 - val_loss: 0.0116
Epoch 20/20
219/219 [==============================] - 2s 7ms/step - loss: 0.0118 - val_loss: 0.0113
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 3ms/step - loss: 0.0113
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.011296751908957958
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d25f907e75b9d48e9f88bd30754201021f21ff724c145c8a53451d709f4a3074.png" src="../../../_images/d25f907e75b9d48e9f88bd30754201021f21ff724c145c8a53451d709f4a3074.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 3ms/step
</pre></div>
</div>
<img alt="../../../_images/48f72d60294129ac7aef1e9bc53b7753858f54bbbc95b9f3954b8dcab4bb8f6d.png" src="../../../_images/48f72d60294129ac7aef1e9bc53b7753858f54bbbc95b9f3954b8dcab4bb8f6d.png" />
</div>
</div>
</section>
<section id="deep-rnns">
<h2>Deep RNNs<a class="headerlink" href="#deep-rnns" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 8s 24ms/step - loss: 0.0213 - val_loss: 0.0086
Epoch 2/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0060 - val_loss: 0.0056
Epoch 3/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0048 - val_loss: 0.0042
Epoch 4/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0040 - val_loss: 0.0034
Epoch 5/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0039 - val_loss: 0.0033
Epoch 6/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0035 - val_loss: 0.0031
Epoch 7/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0035 - val_loss: 0.0041
Epoch 8/20
219/219 [==============================] - 5s 24ms/step - loss: 0.0034 - val_loss: 0.0032
Epoch 9/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0032 - val_loss: 0.0033
Epoch 10/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0031 - val_loss: 0.0030
Epoch 11/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0032 - val_loss: 0.0027
Epoch 12/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0032 - val_loss: 0.0026
Epoch 13/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0031 - val_loss: 0.0031
Epoch 14/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0032 - val_loss: 0.0027
Epoch 15/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0031 - val_loss: 0.0027
Epoch 16/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0030 - val_loss: 0.0030
Epoch 17/20
219/219 [==============================] - 5s 23ms/step - loss: 0.0030 - val_loss: 0.0029
Epoch 18/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0030 - val_loss: 0.0027
Epoch 19/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0030 - val_loss: 0.0027
Epoch 20/20
219/219 [==============================] - 5s 22ms/step - loss: 0.0030 - val_loss: 0.0026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 7ms/step - loss: 0.0026
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0026259785518050194
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7d8a5cfc820626bf128b2badb670c0568bf2a5604ad3f60eb17c83ffb3936c81.png" src="../../../_images/7d8a5cfc820626bf128b2badb670c0568bf2a5604ad3f60eb17c83ffb3936c81.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 1s 7ms/step
</pre></div>
</div>
<img alt="../../../_images/09469e8067585e18537a584f945d2e89c0de8d4609a82ce1b21296bc72345d3a.png" src="../../../_images/09469e8067585e18537a584f945d2e89c0de8d4609a82ce1b21296bc72345d3a.png" />
</div>
</div>
<p>Make the second <code class="docutils literal notranslate"><span class="pre">SimpleRNN</span></code> layer return only the last output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 6s 17ms/step - loss: 0.0109 - val_loss: 0.0041
Epoch 2/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0038 - val_loss: 0.0033
Epoch 3/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0035 - val_loss: 0.0033
Epoch 4/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0033 - val_loss: 0.0032
Epoch 5/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0033 - val_loss: 0.0030
Epoch 6/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0032 - val_loss: 0.0029
Epoch 7/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0031 - val_loss: 0.0031
Epoch 8/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0032 - val_loss: 0.0029
Epoch 9/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0031 - val_loss: 0.0029
Epoch 10/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0030 - val_loss: 0.0029
Epoch 11/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0029 - val_loss: 0.0027
Epoch 12/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0029 - val_loss: 0.0028
Epoch 13/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0030 - val_loss: 0.0028
Epoch 14/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0029 - val_loss: 0.0027
Epoch 15/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0029 - val_loss: 0.0029
Epoch 16/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0029 - val_loss: 0.0027
Epoch 17/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0028 - val_loss: 0.0026
Epoch 18/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0028 - val_loss: 0.0028
Epoch 19/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0028 - val_loss: 0.0025
Epoch 20/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0027 - val_loss: 0.0026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 5ms/step - loss: 0.0026
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0026357118040323257
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3390e7306cc68ef0218b93def8b5c5155244b5a9f21327732c695bc45c4a21c4.png" src="../../../_images/3390e7306cc68ef0218b93def8b5c5155244b5a9f21327732c695bc45c4a21c4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">plot_series</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 1s 5ms/step
</pre></div>
</div>
<img alt="../../../_images/dae7e60561294cfe6fd626cf1bab24bf7861144537043efa9e6ec60173d3bae4.png" src="../../../_images/dae7e60561294cfe6fd626cf1bab24bf7861144537043efa9e6ec60173d3bae4.png" />
</div>
</div>
</section>
<section id="forecasting-several-steps-ahead">
<h2>Forecasting Several Steps Ahead<a class="headerlink" href="#forecasting-several-steps-ahead" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span> <span class="c1"># not 42, as it would give the first series in the train set</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[:,</span> <span class="n">n_steps</span><span class="p">:]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X_new</span>
<span class="k">for</span> <span class="n">step_ahead</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">y_pred_one</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">step_ahead</span><span class="p">:])[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">y_pred_one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">n_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 26ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 28ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y_pred</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 10, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">):</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ahead</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plot_series</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="n">ahead</span><span class="p">),</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;bo-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="n">ahead</span><span class="p">),</span> <span class="n">Y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;rx-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Forecast&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="n">ahead</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">save_fig</span><span class="p">(</span><span class="s2">&quot;forecast_ahead_plot&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving figure forecast_ahead_plot
</pre></div>
</div>
<img alt="../../../_images/8b3010c0b26f87d12579fa40cfaa83f50d65ed96486244c12000e24ef0b0afb1.png" src="../../../_images/8b3010c0b26f87d12579fa40cfaa83f50d65ed96486244c12000e24ef0b0afb1.png" />
</div>
</div>
<p>Now let’s use this model to predict the next 10 values. We first need to regenerate the sequences with 9 more time steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="mi">7000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[:</span><span class="mi">7000</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">9000</span><span class="p">:,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="mi">9000</span><span class="p">:,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s predict the next 10 values one by one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">X_valid</span>
<span class="k">for</span> <span class="n">step_ahead</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">y_pred_one</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">y_pred_one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">n_steps</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 5ms/step
63/63 [==============================] - 1s 5ms/step
63/63 [==============================] - 0s 5ms/step
63/63 [==============================] - 0s 5ms/step
63/63 [==============================] - 0s 6ms/step
63/63 [==============================] - 0s 5ms/step
63/63 [==============================] - 0s 6ms/step
63/63 [==============================] - 0s 5ms/step
63/63 [==============================] - 0s 6ms/step
63/63 [==============================] - 0s 6ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y_pred</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2000, 10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0259473
</pre></div>
</div>
</div>
</div>
<p>Let’s compare this performance with some baselines: naive predictions and a simple linear model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y_naive_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># take the last time step value, and repeat it 10 times</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">,</span> <span class="n">Y_naive_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.25697407
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 1s 2ms/step - loss: 0.1298 - val_loss: 0.0664
Epoch 2/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0537 - val_loss: 0.0454
Epoch 3/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0403 - val_loss: 0.0366
Epoch 4/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0340 - val_loss: 0.0319
Epoch 5/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0303 - val_loss: 0.0290
Epoch 6/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0278 - val_loss: 0.0271
Epoch 7/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0262 - val_loss: 0.0255
Epoch 8/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0249 - val_loss: 0.0244
Epoch 9/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0240 - val_loss: 0.0235
Epoch 10/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0231 - val_loss: 0.0228
Epoch 11/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0224 - val_loss: 0.0222
Epoch 12/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0219 - val_loss: 0.0217
Epoch 13/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0214 - val_loss: 0.0212
Epoch 14/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0210 - val_loss: 0.0211
Epoch 15/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0206 - val_loss: 0.0205
Epoch 16/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0202 - val_loss: 0.0202
Epoch 17/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0199 - val_loss: 0.0198
Epoch 18/20
219/219 [==============================] - 1s 2ms/step - loss: 0.0195 - val_loss: 0.0194
Epoch 19/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0193 - val_loss: 0.0192
Epoch 20/20
219/219 [==============================] - 0s 2ms/step - loss: 0.0190 - val_loss: 0.0189
</pre></div>
</div>
</div>
</div>
<p>Now let’s create an RNN that predicts all 10 next values at once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 6s 16ms/step - loss: 0.0545 - val_loss: 0.0329
Epoch 2/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0278 - val_loss: 0.0223
Epoch 3/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0180 - val_loss: 0.0139
Epoch 4/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0140 - val_loss: 0.0118
Epoch 5/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0123 - val_loss: 0.0106
Epoch 6/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0115 - val_loss: 0.0097
Epoch 7/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0110 - val_loss: 0.0108
Epoch 8/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0108 - val_loss: 0.0092
Epoch 9/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0103 - val_loss: 0.0107
Epoch 10/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0100 - val_loss: 0.0089
Epoch 11/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0100 - val_loss: 0.0105
Epoch 12/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0095 - val_loss: 0.0092
Epoch 13/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0095 - val_loss: 0.0087
Epoch 14/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0092 - val_loss: 0.0085
Epoch 15/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0089 - val_loss: 0.0081
Epoch 16/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0090 - val_loss: 0.0087
Epoch 17/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0090 - val_loss: 0.0105
Epoch 18/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0089 - val_loss: 0.0078
Epoch 19/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0087 - val_loss: 0.0093
Epoch 20/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0088 - val_loss: 0.0090
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="p">:],</span> <span class="n">series</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 282ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/6d25bdc6e01add3546c291460d3373be70ba6f679fc5dff42b9c63c6f58bb5ba.png" src="../../../_images/6d25bdc6e01add3546c291460d3373be70ba6f679fc5dff42b9c63c6f58bb5ba.png" />
</div>
</div>
<p>Now let’s create an RNN that predicts the next 10 steps at each time step. That is, instead of just forecasting time steps 50 to 59 based on time steps 0 to 49, it will forecast time steps 1 to 10 at time step 0, then time steps 2 to 11 at time step 1, and so on, and finally it will forecast time steps 50 to 59 at the last time step. Notice that the model is causal: when it makes predictions at any time step, it can only see past time steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="mi">7000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">]</span>
<span class="n">X_valid</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">9000</span><span class="p">:,</span> <span class="p">:</span><span class="n">n_steps</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">step_ahead</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">step_ahead</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">step_ahead</span><span class="p">:</span><span class="n">step_ahead</span> <span class="o">+</span> <span class="n">n_steps</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:</span><span class="mi">7000</span><span class="p">]</span>
<span class="n">Y_valid</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">7000</span><span class="p">:</span><span class="mi">9000</span><span class="p">]</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">9000</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((7000, 50, 1), (7000, 50, 10))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">last_time_step_mse</span><span class="p">(</span><span class="n">Y_true</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_true</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_pred</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 6s 19ms/step - loss: 0.0471 - last_time_step_mse: 0.0350 - val_loss: 0.0343 - val_last_time_step_mse: 0.0201
Epoch 2/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0343 - last_time_step_mse: 0.0212 - val_loss: 0.0321 - val_last_time_step_mse: 0.0184
Epoch 3/20
219/219 [==============================] - 4s 16ms/step - loss: 0.0308 - last_time_step_mse: 0.0182 - val_loss: 0.0299 - val_last_time_step_mse: 0.0193
Epoch 4/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0297 - last_time_step_mse: 0.0179 - val_loss: 0.0269 - val_last_time_step_mse: 0.0146
Epoch 5/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0272 - last_time_step_mse: 0.0152 - val_loss: 0.0275 - val_last_time_step_mse: 0.0180
Epoch 6/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0268 - last_time_step_mse: 0.0148 - val_loss: 0.0275 - val_last_time_step_mse: 0.0159
Epoch 7/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0242 - last_time_step_mse: 0.0116 - val_loss: 0.0227 - val_last_time_step_mse: 0.0099
Epoch 8/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0229 - last_time_step_mse: 0.0105 - val_loss: 0.0226 - val_last_time_step_mse: 0.0101
Epoch 9/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0217 - last_time_step_mse: 0.0092 - val_loss: 0.0219 - val_last_time_step_mse: 0.0091
Epoch 10/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0211 - last_time_step_mse: 0.0086 - val_loss: 0.0211 - val_last_time_step_mse: 0.0093
Epoch 11/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0205 - last_time_step_mse: 0.0080 - val_loss: 0.0198 - val_last_time_step_mse: 0.0075
Epoch 12/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0202 - last_time_step_mse: 0.0078 - val_loss: 0.0201 - val_last_time_step_mse: 0.0080
Epoch 13/20
219/219 [==============================] - 3s 16ms/step - loss: 0.0200 - last_time_step_mse: 0.0077 - val_loss: 0.0209 - val_last_time_step_mse: 0.0082
Epoch 14/20
219/219 [==============================] - 3s 15ms/step - loss: 0.0192 - last_time_step_mse: 0.0070 - val_loss: 0.0188 - val_last_time_step_mse: 0.0065
Epoch 15/20
219/219 [==============================] - 4s 16ms/step - loss: 0.0191 - last_time_step_mse: 0.0069 - val_loss: 0.0187 - val_last_time_step_mse: 0.0078
Epoch 16/20
219/219 [==============================] - 4s 16ms/step - loss: 0.0187 - last_time_step_mse: 0.0066 - val_loss: 0.0210 - val_last_time_step_mse: 0.0103
Epoch 17/20
219/219 [==============================] - 4s 16ms/step - loss: 0.0190 - last_time_step_mse: 0.0071 - val_loss: 0.0183 - val_last_time_step_mse: 0.0071
Epoch 18/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0187 - last_time_step_mse: 0.0071 - val_loss: 0.0171 - val_last_time_step_mse: 0.0055
Epoch 19/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0184 - last_time_step_mse: 0.0068 - val_loss: 0.0174 - val_last_time_step_mse: 0.0056
Epoch 20/20
219/219 [==============================] - 4s 16ms/step - loss: 0.0182 - last_time_step_mse: 0.0068 - val_loss: 0.0178 - val_last_time_step_mse: 0.0063
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="p">:],</span> <span class="n">series</span><span class="p">[:,</span> <span class="mi">50</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 287ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/db475d17dc7c891ad40652a69e2e36df00dd325d0f11afba14be3ea8e135f6c9.png" src="../../../_images/db475d17dc7c891ad40652a69e2e36df00dd325d0f11afba14be3ea8e135f6c9.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="deep-rnn-with-batch-norm">
<h1>Deep RNN with Batch Norm<a class="headerlink" href="#deep-rnn-with-batch-norm" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 7s 21ms/step - loss: 0.2037 - last_time_step_mse: 0.1996 - val_loss: 0.0782 - val_last_time_step_mse: 0.0699
Epoch 2/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0530 - last_time_step_mse: 0.0410 - val_loss: 0.0532 - val_last_time_step_mse: 0.0429
Epoch 3/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0459 - last_time_step_mse: 0.0338 - val_loss: 0.0455 - val_last_time_step_mse: 0.0337
Epoch 4/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0430 - last_time_step_mse: 0.0312 - val_loss: 0.0430 - val_last_time_step_mse: 0.0315
Epoch 5/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0416 - last_time_step_mse: 0.0300 - val_loss: 0.0414 - val_last_time_step_mse: 0.0296
Epoch 6/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0404 - last_time_step_mse: 0.0287 - val_loss: 0.0402 - val_last_time_step_mse: 0.0287
Epoch 7/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0396 - last_time_step_mse: 0.0280 - val_loss: 0.0392 - val_last_time_step_mse: 0.0271
Epoch 8/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0378 - last_time_step_mse: 0.0253 - val_loss: 0.0367 - val_last_time_step_mse: 0.0225
Epoch 9/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0358 - last_time_step_mse: 0.0219 - val_loss: 0.0360 - val_last_time_step_mse: 0.0222
Epoch 10/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0348 - last_time_step_mse: 0.0208 - val_loss: 0.0354 - val_last_time_step_mse: 0.0203
Epoch 11/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0336 - last_time_step_mse: 0.0194 - val_loss: 0.0348 - val_last_time_step_mse: 0.0219
Epoch 12/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0330 - last_time_step_mse: 0.0187 - val_loss: 0.0324 - val_last_time_step_mse: 0.0180
Epoch 13/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0324 - last_time_step_mse: 0.0181 - val_loss: 0.0317 - val_last_time_step_mse: 0.0172
Epoch 14/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0318 - last_time_step_mse: 0.0176 - val_loss: 0.0348 - val_last_time_step_mse: 0.0210
Epoch 15/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0314 - last_time_step_mse: 0.0172 - val_loss: 0.0314 - val_last_time_step_mse: 0.0171
Epoch 16/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0312 - last_time_step_mse: 0.0173 - val_loss: 0.0318 - val_last_time_step_mse: 0.0169
Epoch 17/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0305 - last_time_step_mse: 0.0164 - val_loss: 0.0326 - val_last_time_step_mse: 0.0191
Epoch 18/20
219/219 [==============================] - 4s 17ms/step - loss: 0.0300 - last_time_step_mse: 0.0161 - val_loss: 0.0309 - val_last_time_step_mse: 0.0166
Epoch 19/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0298 - last_time_step_mse: 0.0160 - val_loss: 0.0319 - val_last_time_step_mse: 0.0198
Epoch 20/20
219/219 [==============================] - 4s 18ms/step - loss: 0.0293 - last_time_step_mse: 0.0158 - val_loss: 0.0310 - val_last_time_step_mse: 0.0168
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="deep-rnns-with-layer-norm">
<h1>Deep RNNs with Layer Norm<a class="headerlink" href="#deep-rnns-with-layer-norm" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">LayerNormalization</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LNSimpleRNNCell</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_rnn_cell</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SimpleRNNCell</span><span class="p">(</span><span class="n">units</span><span class="p">,</span>
                                                          <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_initial_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inputs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">new_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_rnn_cell</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span>
        <span class="n">norm_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_norm</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">norm_outputs</span><span class="p">,</span> <span class="p">[</span><span class="n">norm_outputs</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="n">LNSimpleRNNCell</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="n">LNSimpleRNNCell</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 11s 36ms/step - loss: 0.1400 - last_time_step_mse: 0.1239 - val_loss: 0.0634 - val_last_time_step_mse: 0.0501
Epoch 2/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0559 - last_time_step_mse: 0.0432 - val_loss: 0.0510 - val_last_time_step_mse: 0.0370
Epoch 3/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0481 - last_time_step_mse: 0.0348 - val_loss: 0.0454 - val_last_time_step_mse: 0.0314
Epoch 4/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0440 - last_time_step_mse: 0.0305 - val_loss: 0.0425 - val_last_time_step_mse: 0.0287
Epoch 5/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0408 - last_time_step_mse: 0.0263 - val_loss: 0.0393 - val_last_time_step_mse: 0.0238
Epoch 6/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0385 - last_time_step_mse: 0.0235 - val_loss: 0.0373 - val_last_time_step_mse: 0.0213
Epoch 7/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0366 - last_time_step_mse: 0.0214 - val_loss: 0.0355 - val_last_time_step_mse: 0.0195
Epoch 8/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0349 - last_time_step_mse: 0.0197 - val_loss: 0.0342 - val_last_time_step_mse: 0.0187
Epoch 9/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0335 - last_time_step_mse: 0.0185 - val_loss: 0.0329 - val_last_time_step_mse: 0.0183
Epoch 10/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0323 - last_time_step_mse: 0.0176 - val_loss: 0.0319 - val_last_time_step_mse: 0.0163
Epoch 11/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0315 - last_time_step_mse: 0.0170 - val_loss: 0.0312 - val_last_time_step_mse: 0.0157
Epoch 12/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0308 - last_time_step_mse: 0.0164 - val_loss: 0.0302 - val_last_time_step_mse: 0.0158
Epoch 13/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0299 - last_time_step_mse: 0.0156 - val_loss: 0.0294 - val_last_time_step_mse: 0.0149
Epoch 14/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0295 - last_time_step_mse: 0.0155 - val_loss: 0.0290 - val_last_time_step_mse: 0.0152
Epoch 15/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0291 - last_time_step_mse: 0.0152 - val_loss: 0.0283 - val_last_time_step_mse: 0.0143
Epoch 16/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0287 - last_time_step_mse: 0.0149 - val_loss: 0.0287 - val_last_time_step_mse: 0.0153
Epoch 17/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0283 - last_time_step_mse: 0.0145 - val_loss: 0.0283 - val_last_time_step_mse: 0.0144
Epoch 18/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0279 - last_time_step_mse: 0.0143 - val_loss: 0.0276 - val_last_time_step_mse: 0.0141
Epoch 19/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0276 - last_time_step_mse: 0.0142 - val_loss: 0.0275 - val_last_time_step_mse: 0.0137
Epoch 20/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0272 - last_time_step_mse: 0.0139 - val_loss: 0.0268 - val_last_time_step_mse: 0.0132
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="creating-a-custom-rnn-class">
<h1>Creating a Custom RNN Class<a class="headerlink" href="#creating-a-custom-rnn-class" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyRNN</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span> <span class="o">=</span> <span class="n">return_sequences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_state</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;get_initial_state&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_initial_state</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fallback_initial_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inputs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">state_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_state</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorArray</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">output_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">inputs</span><span class="p">[:,</span> <span class="n">step</span><span class="p">],</span> <span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">:</span>
                <span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sequences</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">MyRNN</span><span class="p">(</span><span class="n">LNSimpleRNNCell</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">MyRNN</span><span class="p">(</span><span class="n">LNSimpleRNNCell</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 12s 42ms/step - loss: 0.1549 - last_time_step_mse: 0.1557 - val_loss: 0.0933 - val_last_time_step_mse: 0.0921
Epoch 2/20
219/219 [==============================] - 9s 41ms/step - loss: 0.0704 - last_time_step_mse: 0.0621 - val_loss: 0.0586 - val_last_time_step_mse: 0.0473
Epoch 3/20
219/219 [==============================] - 9s 39ms/step - loss: 0.0551 - last_time_step_mse: 0.0438 - val_loss: 0.0523 - val_last_time_step_mse: 0.0408
Epoch 4/20
219/219 [==============================] - 8s 38ms/step - loss: 0.0498 - last_time_step_mse: 0.0385 - val_loss: 0.0474 - val_last_time_step_mse: 0.0358
Epoch 5/20
219/219 [==============================] - 9s 42ms/step - loss: 0.0452 - last_time_step_mse: 0.0334 - val_loss: 0.0439 - val_last_time_step_mse: 0.0326
Epoch 6/20
219/219 [==============================] - 9s 39ms/step - loss: 0.0408 - last_time_step_mse: 0.0284 - val_loss: 0.0387 - val_last_time_step_mse: 0.0259
Epoch 7/20
219/219 [==============================] - 8s 38ms/step - loss: 0.0371 - last_time_step_mse: 0.0239 - val_loss: 0.0354 - val_last_time_step_mse: 0.0220
Epoch 8/20
219/219 [==============================] - 8s 38ms/step - loss: 0.0343 - last_time_step_mse: 0.0207 - val_loss: 0.0334 - val_last_time_step_mse: 0.0189
Epoch 9/20
219/219 [==============================] - 9s 40ms/step - loss: 0.0326 - last_time_step_mse: 0.0188 - val_loss: 0.0324 - val_last_time_step_mse: 0.0198
Epoch 10/20
219/219 [==============================] - 9s 41ms/step - loss: 0.0316 - last_time_step_mse: 0.0180 - val_loss: 0.0307 - val_last_time_step_mse: 0.0167
Epoch 11/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0302 - last_time_step_mse: 0.0164 - val_loss: 0.0295 - val_last_time_step_mse: 0.0161
Epoch 12/20
219/219 [==============================] - 9s 41ms/step - loss: 0.0293 - last_time_step_mse: 0.0153 - val_loss: 0.0291 - val_last_time_step_mse: 0.0152
Epoch 13/20
219/219 [==============================] - 9s 40ms/step - loss: 0.0287 - last_time_step_mse: 0.0147 - val_loss: 0.0281 - val_last_time_step_mse: 0.0140
Epoch 14/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0282 - last_time_step_mse: 0.0144 - val_loss: 0.0275 - val_last_time_step_mse: 0.0136
Epoch 15/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0278 - last_time_step_mse: 0.0140 - val_loss: 0.0274 - val_last_time_step_mse: 0.0134
Epoch 16/20
219/219 [==============================] - 9s 39ms/step - loss: 0.0274 - last_time_step_mse: 0.0137 - val_loss: 0.0276 - val_last_time_step_mse: 0.0136
Epoch 17/20
219/219 [==============================] - 8s 37ms/step - loss: 0.0273 - last_time_step_mse: 0.0136 - val_loss: 0.0270 - val_last_time_step_mse: 0.0130
Epoch 18/20
219/219 [==============================] - 9s 40ms/step - loss: 0.0269 - last_time_step_mse: 0.0132 - val_loss: 0.0265 - val_last_time_step_mse: 0.0127
Epoch 19/20
219/219 [==============================] - 9s 40ms/step - loss: 0.0267 - last_time_step_mse: 0.0130 - val_loss: 0.0269 - val_last_time_step_mse: 0.0130
Epoch 20/20
219/219 [==============================] - 8s 38ms/step - loss: 0.0263 - last_time_step_mse: 0.0127 - val_loss: 0.0264 - val_last_time_step_mse: 0.0129
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="lstms">
<h1>LSTMs<a class="headerlink" href="#lstms" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 12s 37ms/step - loss: 0.0771 - last_time_step_mse: 0.0618 - val_loss: 0.0536 - val_last_time_step_mse: 0.0337
Epoch 2/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0466 - last_time_step_mse: 0.0258 - val_loss: 0.0417 - val_last_time_step_mse: 0.0199
Epoch 3/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0388 - last_time_step_mse: 0.0177 - val_loss: 0.0373 - val_last_time_step_mse: 0.0172
Epoch 4/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0351 - last_time_step_mse: 0.0151 - val_loss: 0.0337 - val_last_time_step_mse: 0.0142
Epoch 5/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0329 - last_time_step_mse: 0.0139 - val_loss: 0.0322 - val_last_time_step_mse: 0.0142
Epoch 6/20
219/219 [==============================] - 7s 32ms/step - loss: 0.0312 - last_time_step_mse: 0.0129 - val_loss: 0.0302 - val_last_time_step_mse: 0.0118
Epoch 7/20
219/219 [==============================] - 7s 32ms/step - loss: 0.0297 - last_time_step_mse: 0.0117 - val_loss: 0.0290 - val_last_time_step_mse: 0.0118
Epoch 8/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0283 - last_time_step_mse: 0.0107 - val_loss: 0.0277 - val_last_time_step_mse: 0.0101
Epoch 9/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0277 - last_time_step_mse: 0.0104 - val_loss: 0.0279 - val_last_time_step_mse: 0.0114
Epoch 10/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0270 - last_time_step_mse: 0.0101 - val_loss: 0.0264 - val_last_time_step_mse: 0.0097
Epoch 11/20
219/219 [==============================] - 8s 35ms/step - loss: 0.0265 - last_time_step_mse: 0.0099 - val_loss: 0.0264 - val_last_time_step_mse: 0.0100
Epoch 12/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0262 - last_time_step_mse: 0.0100 - val_loss: 0.0257 - val_last_time_step_mse: 0.0094
Epoch 13/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0257 - last_time_step_mse: 0.0095 - val_loss: 0.0254 - val_last_time_step_mse: 0.0094
Epoch 14/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0254 - last_time_step_mse: 0.0095 - val_loss: 0.0250 - val_last_time_step_mse: 0.0089
Epoch 15/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0250 - last_time_step_mse: 0.0093 - val_loss: 0.0247 - val_last_time_step_mse: 0.0089
Epoch 16/20
219/219 [==============================] - 8s 34ms/step - loss: 0.0249 - last_time_step_mse: 0.0095 - val_loss: 0.0248 - val_last_time_step_mse: 0.0095
Epoch 17/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0245 - last_time_step_mse: 0.0092 - val_loss: 0.0250 - val_last_time_step_mse: 0.0107
Epoch 18/20
219/219 [==============================] - 8s 34ms/step - loss: 0.0242 - last_time_step_mse: 0.0091 - val_loss: 0.0245 - val_last_time_step_mse: 0.0093
Epoch 19/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0240 - last_time_step_mse: 0.0089 - val_loss: 0.0241 - val_last_time_step_mse: 0.0101
Epoch 20/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0237 - last_time_step_mse: 0.0088 - val_loss: 0.0238 - val_last_time_step_mse: 0.0087
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 1s 9ms/step - loss: 0.0238 - last_time_step_mse: 0.0087
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.023769903928041458, 0.008721509948372841]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/1437a2b4db80570e40b2967ab718b541a6951ef93a2f21144be84c0ce976ebb2.png" src="../../../_images/1437a2b4db80570e40b2967ab718b541a6951ef93a2f21144be84c0ce976ebb2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="p">:],</span> <span class="n">series</span><span class="p">[:,</span> <span class="mi">50</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 1s 804ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b54ee1ec689f6d7e1075e618c0ea5dd981fbb824c7e91e7e20de522d79ef21b4.png" src="../../../_images/b54ee1ec689f6d7e1075e618c0ea5dd981fbb824c7e91e7e20de522d79ef21b4.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="grus">
<h1>GRUs<a class="headerlink" href="#grus" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 13s 39ms/step - loss: 0.0766 - last_time_step_mse: 0.0685 - val_loss: 0.0516 - val_last_time_step_mse: 0.0403
Epoch 2/20
219/219 [==============================] - 8s 35ms/step - loss: 0.0472 - last_time_step_mse: 0.0363 - val_loss: 0.0436 - val_last_time_step_mse: 0.0320
Epoch 3/20
219/219 [==============================] - 8s 35ms/step - loss: 0.0417 - last_time_step_mse: 0.0305 - val_loss: 0.0392 - val_last_time_step_mse: 0.0286
Epoch 4/20
219/219 [==============================] - 8s 36ms/step - loss: 0.0384 - last_time_step_mse: 0.0277 - val_loss: 0.0366 - val_last_time_step_mse: 0.0256
Epoch 5/20
219/219 [==============================] - 8s 35ms/step - loss: 0.0358 - last_time_step_mse: 0.0251 - val_loss: 0.0345 - val_last_time_step_mse: 0.0247
Epoch 6/20
219/219 [==============================] - 8s 35ms/step - loss: 0.0335 - last_time_step_mse: 0.0223 - val_loss: 0.0323 - val_last_time_step_mse: 0.0214
Epoch 7/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0315 - last_time_step_mse: 0.0190 - val_loss: 0.0315 - val_last_time_step_mse: 0.0206
Epoch 8/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0295 - last_time_step_mse: 0.0161 - val_loss: 0.0284 - val_last_time_step_mse: 0.0149
Epoch 9/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0284 - last_time_step_mse: 0.0147 - val_loss: 0.0280 - val_last_time_step_mse: 0.0144
Epoch 10/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0276 - last_time_step_mse: 0.0138 - val_loss: 0.0274 - val_last_time_step_mse: 0.0142
Epoch 11/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0269 - last_time_step_mse: 0.0130 - val_loss: 0.0263 - val_last_time_step_mse: 0.0126
Epoch 12/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0265 - last_time_step_mse: 0.0127 - val_loss: 0.0260 - val_last_time_step_mse: 0.0125
Epoch 13/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0260 - last_time_step_mse: 0.0121 - val_loss: 0.0260 - val_last_time_step_mse: 0.0128
Epoch 14/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0256 - last_time_step_mse: 0.0117 - val_loss: 0.0256 - val_last_time_step_mse: 0.0123
Epoch 15/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0253 - last_time_step_mse: 0.0114 - val_loss: 0.0251 - val_last_time_step_mse: 0.0116
Epoch 16/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0249 - last_time_step_mse: 0.0110 - val_loss: 0.0248 - val_last_time_step_mse: 0.0109
Epoch 17/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0246 - last_time_step_mse: 0.0106 - val_loss: 0.0247 - val_last_time_step_mse: 0.0108
Epoch 18/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0242 - last_time_step_mse: 0.0102 - val_loss: 0.0241 - val_last_time_step_mse: 0.0102
Epoch 19/20
219/219 [==============================] - 7s 33ms/step - loss: 0.0238 - last_time_step_mse: 0.0097 - val_loss: 0.0236 - val_last_time_step_mse: 0.0096
Epoch 20/20
219/219 [==============================] - 7s 34ms/step - loss: 0.0232 - last_time_step_mse: 0.0091 - val_loss: 0.0230 - val_last_time_step_mse: 0.0089
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 8ms/step - loss: 0.0230 - last_time_step_mse: 0.0089
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.022951852530241013, 0.008920284919440746]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_learning_curves</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/def2ab2bf0c70ee76dd7ba1369e8ba8af151822a09387cc77df907ee22619842.png" src="../../../_images/def2ab2bf0c70ee76dd7ba1369e8ba8af151822a09387cc77df907ee22619842.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="p">:],</span> <span class="n">series</span><span class="p">[:,</span> <span class="mi">50</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 571 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7f5363eed000&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
1/1 [==============================] - 1s 771ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_multiple_forecasts</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/dd65264f17ea834591c3415c004b9c3a0c41c281e9114cf2c12ee58913e2bcf8.png" src="../../../_images/dd65264f17ea834591c3415c004b9c3a0c41c281e9114cf2c12ee58913e2bcf8.png" />
</div>
</div>
<section id="using-one-dimensional-convolutional-layers-to-process-sequences">
<h2>Using One-Dimensional Convolutional Layers to Process Sequences<a class="headerlink" href="#using-one-dimensional-convolutional-layers-to-process-sequences" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="n">D</span> <span class="n">conv</span> <span class="n">layer</span> <span class="k">with</span> <span class="n">kernel</span> <span class="n">size</span> <span class="mi">4</span><span class="p">,</span> <span class="n">stride</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VALID</span> <span class="n">padding</span><span class="p">:</span>

              <span class="o">|-----</span><span class="mi">2</span><span class="o">-----|</span>     <span class="o">|-----</span><span class="mi">5</span><span class="o">---...------|</span>     <span class="o">|-----</span><span class="mi">23</span><span class="o">----|</span>
        <span class="o">|-----</span><span class="mi">1</span><span class="o">-----|</span>     <span class="o">|-----</span><span class="mi">4</span><span class="o">-----|</span>   <span class="o">...</span>      <span class="o">|-----</span><span class="mi">22</span><span class="o">----|</span>
  <span class="o">|-----</span><span class="mi">0</span><span class="o">----|</span>      <span class="o">|-----</span><span class="mi">3</span><span class="o">-----|</span>     <span class="o">|---...|-----</span><span class="mi">21</span><span class="o">----|</span>
<span class="n">X</span><span class="p">:</span> <span class="mi">0</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="o">...</span> <span class="mi">42</span> <span class="mi">43</span> <span class="mi">44</span> <span class="mi">45</span> <span class="mi">46</span> <span class="mi">47</span> <span class="mi">48</span> <span class="mi">49</span>
<span class="n">Y</span><span class="p">:</span> <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="mi">13</span> <span class="o">...</span> <span class="mi">43</span> <span class="mi">44</span> <span class="mi">45</span> <span class="mi">46</span> <span class="mi">47</span> <span class="mi">48</span> <span class="mi">49</span> <span class="mi">50</span>
  <span class="o">/</span><span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="mi">13</span> <span class="mi">14</span> <span class="mi">15</span> <span class="mi">16</span> <span class="mi">17</span> <span class="mi">18</span> <span class="mi">19</span> <span class="mi">20</span> <span class="mi">21</span> <span class="mi">22</span> <span class="o">...</span> <span class="mi">52</span> <span class="mi">53</span> <span class="mi">54</span> <span class="mi">55</span> <span class="mi">56</span> <span class="mi">57</span> <span class="mi">58</span> <span class="mi">59</span>

<span class="n">Output</span><span class="p">:</span>

<span class="n">X</span><span class="p">:</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">3</span>   <span class="mi">2</span><span class="o">/</span><span class="mi">5</span>   <span class="mi">4</span><span class="o">/</span><span class="mi">7</span>   <span class="mi">6</span><span class="o">/</span><span class="mi">9</span>   <span class="mi">8</span><span class="o">/</span><span class="mi">11</span> <span class="mi">10</span><span class="o">/</span><span class="mi">13</span> <span class="o">.../</span><span class="mi">43</span> <span class="mi">42</span><span class="o">/</span><span class="mi">45</span> <span class="mi">44</span><span class="o">/</span><span class="mi">47</span> <span class="mi">46</span><span class="o">/</span><span class="mi">49</span>
<span class="n">Y</span><span class="p">:</span>     <span class="mi">4</span><span class="o">/</span><span class="mi">13</span>  <span class="mi">6</span><span class="o">/</span><span class="mi">15</span>  <span class="mi">8</span><span class="o">/</span><span class="mi">17</span> <span class="mi">10</span><span class="o">/</span><span class="mi">19</span> <span class="mi">12</span><span class="o">/</span><span class="mi">21</span> <span class="mi">14</span><span class="o">/</span><span class="mi">23</span> <span class="o">.../</span><span class="mi">53</span> <span class="mi">46</span><span class="o">/</span><span class="mi">55</span> <span class="mi">48</span><span class="o">/</span><span class="mi">57</span> <span class="mi">50</span><span class="o">/</span><span class="mi">59</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 9s 23ms/step - loss: 0.0758 - last_time_step_mse: 0.0675 - val_loss: 0.0485 - val_last_time_step_mse: 0.0400
Epoch 2/20
219/219 [==============================] - 5s 21ms/step - loss: 0.0403 - last_time_step_mse: 0.0323 - val_loss: 0.0340 - val_last_time_step_mse: 0.0254
Epoch 3/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0313 - last_time_step_mse: 0.0222 - val_loss: 0.0288 - val_last_time_step_mse: 0.0191
Epoch 4/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0273 - last_time_step_mse: 0.0170 - val_loss: 0.0260 - val_last_time_step_mse: 0.0156
Epoch 5/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0250 - last_time_step_mse: 0.0142 - val_loss: 0.0246 - val_last_time_step_mse: 0.0143
Epoch 6/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0235 - last_time_step_mse: 0.0126 - val_loss: 0.0229 - val_last_time_step_mse: 0.0118
Epoch 7/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0227 - last_time_step_mse: 0.0117 - val_loss: 0.0224 - val_last_time_step_mse: 0.0117
Epoch 8/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0220 - last_time_step_mse: 0.0112 - val_loss: 0.0218 - val_last_time_step_mse: 0.0109
Epoch 9/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0216 - last_time_step_mse: 0.0108 - val_loss: 0.0215 - val_last_time_step_mse: 0.0106
Epoch 10/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0213 - last_time_step_mse: 0.0106 - val_loss: 0.0211 - val_last_time_step_mse: 0.0103
Epoch 11/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0209 - last_time_step_mse: 0.0102 - val_loss: 0.0208 - val_last_time_step_mse: 0.0102
Epoch 12/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0207 - last_time_step_mse: 0.0101 - val_loss: 0.0209 - val_last_time_step_mse: 0.0105
Epoch 13/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0204 - last_time_step_mse: 0.0098 - val_loss: 0.0203 - val_last_time_step_mse: 0.0098
Epoch 14/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0201 - last_time_step_mse: 0.0097 - val_loss: 0.0201 - val_last_time_step_mse: 0.0098
Epoch 15/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0200 - last_time_step_mse: 0.0096 - val_loss: 0.0200 - val_last_time_step_mse: 0.0098
Epoch 16/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0197 - last_time_step_mse: 0.0095 - val_loss: 0.0199 - val_last_time_step_mse: 0.0095
Epoch 17/20
219/219 [==============================] - 4s 20ms/step - loss: 0.0195 - last_time_step_mse: 0.0092 - val_loss: 0.0195 - val_last_time_step_mse: 0.0091
Epoch 18/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0192 - last_time_step_mse: 0.0090 - val_loss: 0.0193 - val_last_time_step_mse: 0.0089
Epoch 19/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0191 - last_time_step_mse: 0.0091 - val_loss: 0.0188 - val_last_time_step_mse: 0.0085
Epoch 20/20
219/219 [==============================] - 4s 19ms/step - loss: 0.0188 - last_time_step_mse: 0.0087 - val_loss: 0.0187 - val_last_time_step_mse: 0.0084
</pre></div>
</div>
</div>
</div>
</section>
<section id="wavenet">
<h2>WaveNet<a class="headerlink" href="#wavenet" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C2</span>  <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\<span class="o">.../</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\
   \  <span class="o">/</span>  \  <span class="o">/</span>  \  <span class="o">/</span>  \  <span class="o">/</span>  \  <span class="o">/</span>  \  <span class="o">/</span>  \       <span class="o">/</span>  \  <span class="o">/</span>  \  <span class="o">/</span>  \
     <span class="o">/</span>    \      <span class="o">/</span>    \      <span class="o">/</span>    \                 <span class="o">/</span>    \
<span class="n">C1</span>  <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\  <span class="o">/</span>\ <span class="o">/.../</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\ <span class="o">/</span>\
<span class="n">X</span><span class="p">:</span> <span class="mi">0</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="o">...</span> <span class="mi">43</span> <span class="mi">44</span> <span class="mi">45</span> <span class="mi">46</span> <span class="mi">47</span> <span class="mi">48</span> <span class="mi">49</span>
<span class="n">Y</span><span class="p">:</span> <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="mi">13</span> <span class="o">...</span> <span class="mi">44</span> <span class="mi">45</span> <span class="mi">46</span> <span class="mi">47</span> <span class="mi">48</span> <span class="mi">49</span> <span class="mi">50</span>
  <span class="o">/</span><span class="mi">10</span> <span class="mi">11</span> <span class="mi">12</span> <span class="mi">13</span> <span class="mi">14</span> <span class="mi">15</span> <span class="mi">16</span> <span class="mi">17</span> <span class="mi">18</span> <span class="mi">19</span> <span class="mi">20</span> <span class="mi">21</span> <span class="mi">22</span> <span class="o">...</span> <span class="mi">53</span> <span class="mi">54</span> <span class="mi">55</span> <span class="mi">56</span> <span class="mi">57</span> <span class="mi">58</span> <span class="mi">59</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="n">rate</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
219/219 [==============================] - 5s 13ms/step - loss: 0.0692 - last_time_step_mse: 0.0565 - val_loss: 0.0354 - val_last_time_step_mse: 0.0214
Epoch 2/20
219/219 [==============================] - 3s 12ms/step - loss: 0.0323 - last_time_step_mse: 0.0196 - val_loss: 0.0297 - val_last_time_step_mse: 0.0173
Epoch 3/20
219/219 [==============================] - 3s 11ms/step - loss: 0.0286 - last_time_step_mse: 0.0164 - val_loss: 0.0275 - val_last_time_step_mse: 0.0158
Epoch 4/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0267 - last_time_step_mse: 0.0147 - val_loss: 0.0261 - val_last_time_step_mse: 0.0143
Epoch 5/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0254 - last_time_step_mse: 0.0135 - val_loss: 0.0248 - val_last_time_step_mse: 0.0130
Epoch 6/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0244 - last_time_step_mse: 0.0125 - val_loss: 0.0238 - val_last_time_step_mse: 0.0119
Epoch 7/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0239 - last_time_step_mse: 0.0121 - val_loss: 0.0232 - val_last_time_step_mse: 0.0114
Epoch 8/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0231 - last_time_step_mse: 0.0113 - val_loss: 0.0227 - val_last_time_step_mse: 0.0110
Epoch 9/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0226 - last_time_step_mse: 0.0110 - val_loss: 0.0233 - val_last_time_step_mse: 0.0121
Epoch 10/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0224 - last_time_step_mse: 0.0108 - val_loss: 0.0224 - val_last_time_step_mse: 0.0109
Epoch 11/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0220 - last_time_step_mse: 0.0104 - val_loss: 0.0216 - val_last_time_step_mse: 0.0104
Epoch 12/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0217 - last_time_step_mse: 0.0102 - val_loss: 0.0215 - val_last_time_step_mse: 0.0102
Epoch 13/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0213 - last_time_step_mse: 0.0099 - val_loss: 0.0216 - val_last_time_step_mse: 0.0100
Epoch 14/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0212 - last_time_step_mse: 0.0097 - val_loss: 0.0209 - val_last_time_step_mse: 0.0094
Epoch 15/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0209 - last_time_step_mse: 0.0094 - val_loss: 0.0205 - val_last_time_step_mse: 0.0092
Epoch 16/20
219/219 [==============================] - 3s 11ms/step - loss: 0.0209 - last_time_step_mse: 0.0095 - val_loss: 0.0205 - val_last_time_step_mse: 0.0092
Epoch 17/20
219/219 [==============================] - 3s 12ms/step - loss: 0.0204 - last_time_step_mse: 0.0091 - val_loss: 0.0200 - val_last_time_step_mse: 0.0088
Epoch 18/20
219/219 [==============================] - 3s 12ms/step - loss: 0.0202 - last_time_step_mse: 0.0089 - val_loss: 0.0201 - val_last_time_step_mse: 0.0092
Epoch 19/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0199 - last_time_step_mse: 0.0086 - val_loss: 0.0195 - val_last_time_step_mse: 0.0085
Epoch 20/20
219/219 [==============================] - 2s 11ms/step - loss: 0.0197 - last_time_step_mse: 0.0084 - val_loss: 0.0193 - val_last_time_step_mse: 0.0083
</pre></div>
</div>
</div>
</div>
<p>Here is the original WaveNet defined in the paper: it uses Gated Activation Units instead of ReLU and parametrized skip connections, plus it pads with zeros on the left to avoid getting shorter and shorter sequences:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GatedActivationUnit</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">n_filters</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">linear_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">n_filters</span><span class="p">])</span>
        <span class="n">gate</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">:])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">linear_output</span><span class="p">)</span> <span class="o">*</span> <span class="n">gate</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wavenet_residual_block</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span>
                            <span class="n">dilation_rate</span><span class="o">=</span><span class="n">dilation_rate</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">GatedActivationUnit</span><span class="p">()(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">z</span><span class="p">,</span> <span class="n">inputs</span><span class="p">]),</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_layers_per_block</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># 10 in the paper</span>
<span class="n">n_blocks</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 3 in the paper</span>
<span class="n">n_filters</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># 128 in the paper</span>
<span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># 256 in the paper</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">skip_to_last</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dilation_rate</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers_per_block</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_blocks</span><span class="p">:</span>
    <span class="n">z</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">wavenet_residual_block</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="p">)</span>
    <span class="n">skip_to_last</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()(</span><span class="n">skip_to_last</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
<span class="n">Y_proba</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">n_outputs</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">inputs</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">Y_proba</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">last_time_step_mse</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/2
219/219 [==============================] - 7s 21ms/step - loss: 0.1299 - last_time_step_mse: 0.1259 - val_loss: 0.1231 - val_last_time_step_mse: 0.1201
Epoch 2/2
219/219 [==============================] - 4s 19ms/step - loss: 0.1222 - last_time_step_mse: 0.1178 - val_loss: 0.1217 - val_last_time_step_mse: 0.1189
</pre></div>
</div>
</div>
</div>
<p>In this chapter we explored the fundamentals of RNNs and used them to process sequences (namely, time series). In the process we also looked at other ways to process sequences, including CNNs. In the next chapter we will use RNNs for Natural Language Processing, and we will learn more about RNNs (bidirectional RNNs, stateful vs stateless RNNs, Encoder–Decoders, and Attention-augmented Encoder-Decoders). We will also look at the Transformer, an Attention-only architecture.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exercise-solutions">
<h1>Exercise solutions<a class="headerlink" href="#exercise-solutions" title="Permalink to this headline">#</a></h1>
<section id="to-8">
<h2>1. to 8.<a class="headerlink" href="#to-8" title="Permalink to this headline">#</a></h2>
<p>See Appendix A.</p>
</section>
<section id="tackling-the-sketchrnn-dataset">
<h2>9. Tackling the SketchRNN Dataset<a class="headerlink" href="#tackling-the-sketchrnn-dataset" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: Train a classification model for the SketchRNN dataset, available in TensorFlow Datasets.</em></p>
<p>The dataset is not available in TFDS yet, the <a class="reference external" href="https://github.com/tensorflow/datasets/pull/361">pull request</a> is still work in progress. Luckily, the data is conveniently available as TFRecords, so let’s download it (it might take a while, as it’s about 1 GB large, with 3,450,000 training sketches and 345,000 test sketches):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DOWNLOAD_ROOT</span> <span class="o">=</span> <span class="s2">&quot;http://download.tensorflow.org/data/&quot;</span>
<span class="n">FILENAME</span> <span class="o">=</span> <span class="s2">&quot;quickdraw_tutorial_dataset_v1.tar.gz&quot;</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span>
                                <span class="n">DOWNLOAD_ROOT</span> <span class="o">+</span> <span class="n">FILENAME</span><span class="p">,</span>
                                <span class="n">cache_subdir</span><span class="o">=</span><span class="s2">&quot;datasets/quickdraw&quot;</span><span class="p">,</span>
                                <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from http://download.tensorflow.org/data/quickdraw_tutorial_dataset_v1.tar.gz
1065301781/1065301781 [==============================] - 13s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quickdraw_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
<span class="n">train_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">quickdraw_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;training.tfrecord-*&quot;</span><span class="p">)])</span>
<span class="n">eval_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">quickdraw_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;eval.tfrecord-*&quot;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00000-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00001-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00002-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00003-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00004-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00005-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00006-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00007-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00008-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/training.tfrecord-00009-of-00010&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00000-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00001-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00002-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00003-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00004-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00005-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00006-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00007-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00008-of-00010&#39;,
 &#39;/home/runner/.keras/datasets/quickdraw/eval.tfrecord-00009-of-00010&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">quickdraw_dir</span> <span class="o">/</span> <span class="s2">&quot;eval.tfrecord.classes&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">test_classes_file</span><span class="p">:</span>
    <span class="n">test_classes</span> <span class="o">=</span> <span class="n">test_classes_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">quickdraw_dir</span> <span class="o">/</span> <span class="s2">&quot;training.tfrecord.classes&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_classes_file</span><span class="p">:</span>
    <span class="n">train_classes</span> <span class="o">=</span> <span class="n">train_classes_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">train_classes</span> <span class="o">==</span> <span class="n">test_classes</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">train_classes</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">sorted</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aircraft carrier&#39;,
 &#39;airplane&#39;,
 &#39;alarm clock&#39;,
 &#39;ambulance&#39;,
 &#39;angel&#39;,
 &#39;animal migration&#39;,
 &#39;ant&#39;,
 &#39;anvil&#39;,
 &#39;apple&#39;,
 &#39;arm&#39;,
 &#39;asparagus&#39;,
 &#39;axe&#39;,
 &#39;backpack&#39;,
 &#39;banana&#39;,
 &#39;bandage&#39;,
 &#39;barn&#39;,
 &#39;baseball&#39;,
 &#39;baseball bat&#39;,
 &#39;basket&#39;,
 &#39;basketball&#39;,
 &#39;bat&#39;,
 &#39;bathtub&#39;,
 &#39;beach&#39;,
 &#39;bear&#39;,
 &#39;beard&#39;,
 &#39;bed&#39;,
 &#39;bee&#39;,
 &#39;belt&#39;,
 &#39;bench&#39;,
 &#39;bicycle&#39;,
 &#39;binoculars&#39;,
 &#39;bird&#39;,
 &#39;birthday cake&#39;,
 &#39;blackberry&#39;,
 &#39;blueberry&#39;,
 &#39;book&#39;,
 &#39;boomerang&#39;,
 &#39;bottlecap&#39;,
 &#39;bowtie&#39;,
 &#39;bracelet&#39;,
 &#39;brain&#39;,
 &#39;bread&#39;,
 &#39;bridge&#39;,
 &#39;broccoli&#39;,
 &#39;broom&#39;,
 &#39;bucket&#39;,
 &#39;bulldozer&#39;,
 &#39;bus&#39;,
 &#39;bush&#39;,
 &#39;butterfly&#39;,
 &#39;cactus&#39;,
 &#39;cake&#39;,
 &#39;calculator&#39;,
 &#39;calendar&#39;,
 &#39;camel&#39;,
 &#39;camera&#39;,
 &#39;camouflage&#39;,
 &#39;campfire&#39;,
 &#39;candle&#39;,
 &#39;cannon&#39;,
 &#39;canoe&#39;,
 &#39;car&#39;,
 &#39;carrot&#39;,
 &#39;castle&#39;,
 &#39;cat&#39;,
 &#39;ceiling fan&#39;,
 &#39;cell phone&#39;,
 &#39;cello&#39;,
 &#39;chair&#39;,
 &#39;chandelier&#39;,
 &#39;church&#39;,
 &#39;circle&#39;,
 &#39;clarinet&#39;,
 &#39;clock&#39;,
 &#39;cloud&#39;,
 &#39;coffee cup&#39;,
 &#39;compass&#39;,
 &#39;computer&#39;,
 &#39;cookie&#39;,
 &#39;cooler&#39;,
 &#39;couch&#39;,
 &#39;cow&#39;,
 &#39;crab&#39;,
 &#39;crayon&#39;,
 &#39;crocodile&#39;,
 &#39;crown&#39;,
 &#39;cruise ship&#39;,
 &#39;cup&#39;,
 &#39;diamond&#39;,
 &#39;dishwasher&#39;,
 &#39;diving board&#39;,
 &#39;dog&#39;,
 &#39;dolphin&#39;,
 &#39;donut&#39;,
 &#39;door&#39;,
 &#39;dragon&#39;,
 &#39;dresser&#39;,
 &#39;drill&#39;,
 &#39;drums&#39;,
 &#39;duck&#39;,
 &#39;dumbbell&#39;,
 &#39;ear&#39;,
 &#39;elbow&#39;,
 &#39;elephant&#39;,
 &#39;envelope&#39;,
 &#39;eraser&#39;,
 &#39;eye&#39;,
 &#39;eyeglasses&#39;,
 &#39;face&#39;,
 &#39;fan&#39;,
 &#39;feather&#39;,
 &#39;fence&#39;,
 &#39;finger&#39;,
 &#39;fire hydrant&#39;,
 &#39;fireplace&#39;,
 &#39;firetruck&#39;,
 &#39;fish&#39;,
 &#39;flamingo&#39;,
 &#39;flashlight&#39;,
 &#39;flip flops&#39;,
 &#39;floor lamp&#39;,
 &#39;flower&#39;,
 &#39;flying saucer&#39;,
 &#39;foot&#39;,
 &#39;fork&#39;,
 &#39;frog&#39;,
 &#39;frying pan&#39;,
 &#39;garden&#39;,
 &#39;garden hose&#39;,
 &#39;giraffe&#39;,
 &#39;goatee&#39;,
 &#39;golf club&#39;,
 &#39;grapes&#39;,
 &#39;grass&#39;,
 &#39;guitar&#39;,
 &#39;hamburger&#39;,
 &#39;hammer&#39;,
 &#39;hand&#39;,
 &#39;harp&#39;,
 &#39;hat&#39;,
 &#39;headphones&#39;,
 &#39;hedgehog&#39;,
 &#39;helicopter&#39;,
 &#39;helmet&#39;,
 &#39;hexagon&#39;,
 &#39;hockey puck&#39;,
 &#39;hockey stick&#39;,
 &#39;horse&#39;,
 &#39;hospital&#39;,
 &#39;hot air balloon&#39;,
 &#39;hot dog&#39;,
 &#39;hot tub&#39;,
 &#39;hourglass&#39;,
 &#39;house&#39;,
 &#39;house plant&#39;,
 &#39;hurricane&#39;,
 &#39;ice cream&#39;,
 &#39;jacket&#39;,
 &#39;jail&#39;,
 &#39;kangaroo&#39;,
 &#39;key&#39;,
 &#39;keyboard&#39;,
 &#39;knee&#39;,
 &#39;knife&#39;,
 &#39;ladder&#39;,
 &#39;lantern&#39;,
 &#39;laptop&#39;,
 &#39;leaf&#39;,
 &#39;leg&#39;,
 &#39;light bulb&#39;,
 &#39;lighter&#39;,
 &#39;lighthouse&#39;,
 &#39;lightning&#39;,
 &#39;line&#39;,
 &#39;lion&#39;,
 &#39;lipstick&#39;,
 &#39;lobster&#39;,
 &#39;lollipop&#39;,
 &#39;mailbox&#39;,
 &#39;map&#39;,
 &#39;marker&#39;,
 &#39;matches&#39;,
 &#39;megaphone&#39;,
 &#39;mermaid&#39;,
 &#39;microphone&#39;,
 &#39;microwave&#39;,
 &#39;monkey&#39;,
 &#39;moon&#39;,
 &#39;mosquito&#39;,
 &#39;motorbike&#39;,
 &#39;mountain&#39;,
 &#39;mouse&#39;,
 &#39;moustache&#39;,
 &#39;mouth&#39;,
 &#39;mug&#39;,
 &#39;mushroom&#39;,
 &#39;nail&#39;,
 &#39;necklace&#39;,
 &#39;nose&#39;,
 &#39;ocean&#39;,
 &#39;octagon&#39;,
 &#39;octopus&#39;,
 &#39;onion&#39;,
 &#39;oven&#39;,
 &#39;owl&#39;,
 &#39;paint can&#39;,
 &#39;paintbrush&#39;,
 &#39;palm tree&#39;,
 &#39;panda&#39;,
 &#39;pants&#39;,
 &#39;paper clip&#39;,
 &#39;parachute&#39;,
 &#39;parrot&#39;,
 &#39;passport&#39;,
 &#39;peanut&#39;,
 &#39;pear&#39;,
 &#39;peas&#39;,
 &#39;pencil&#39;,
 &#39;penguin&#39;,
 &#39;piano&#39;,
 &#39;pickup truck&#39;,
 &#39;picture frame&#39;,
 &#39;pig&#39;,
 &#39;pillow&#39;,
 &#39;pineapple&#39;,
 &#39;pizza&#39;,
 &#39;pliers&#39;,
 &#39;police car&#39;,
 &#39;pond&#39;,
 &#39;pool&#39;,
 &#39;popsicle&#39;,
 &#39;postcard&#39;,
 &#39;potato&#39;,
 &#39;power outlet&#39;,
 &#39;purse&#39;,
 &#39;rabbit&#39;,
 &#39;raccoon&#39;,
 &#39;radio&#39;,
 &#39;rain&#39;,
 &#39;rainbow&#39;,
 &#39;rake&#39;,
 &#39;remote control&#39;,
 &#39;rhinoceros&#39;,
 &#39;rifle&#39;,
 &#39;river&#39;,
 &#39;roller coaster&#39;,
 &#39;rollerskates&#39;,
 &#39;sailboat&#39;,
 &#39;sandwich&#39;,
 &#39;saw&#39;,
 &#39;saxophone&#39;,
 &#39;school bus&#39;,
 &#39;scissors&#39;,
 &#39;scorpion&#39;,
 &#39;screwdriver&#39;,
 &#39;sea turtle&#39;,
 &#39;see saw&#39;,
 &#39;shark&#39;,
 &#39;sheep&#39;,
 &#39;shoe&#39;,
 &#39;shorts&#39;,
 &#39;shovel&#39;,
 &#39;sink&#39;,
 &#39;skateboard&#39;,
 &#39;skull&#39;,
 &#39;skyscraper&#39;,
 &#39;sleeping bag&#39;,
 &#39;smiley face&#39;,
 &#39;snail&#39;,
 &#39;snake&#39;,
 &#39;snorkel&#39;,
 &#39;snowflake&#39;,
 &#39;snowman&#39;,
 &#39;soccer ball&#39;,
 &#39;sock&#39;,
 &#39;speedboat&#39;,
 &#39;spider&#39;,
 &#39;spoon&#39;,
 &#39;spreadsheet&#39;,
 &#39;square&#39;,
 &#39;squiggle&#39;,
 &#39;squirrel&#39;,
 &#39;stairs&#39;,
 &#39;star&#39;,
 &#39;steak&#39;,
 &#39;stereo&#39;,
 &#39;stethoscope&#39;,
 &#39;stitches&#39;,
 &#39;stop sign&#39;,
 &#39;stove&#39;,
 &#39;strawberry&#39;,
 &#39;streetlight&#39;,
 &#39;string bean&#39;,
 &#39;submarine&#39;,
 &#39;suitcase&#39;,
 &#39;sun&#39;,
 &#39;swan&#39;,
 &#39;sweater&#39;,
 &#39;swing set&#39;,
 &#39;sword&#39;,
 &#39;syringe&#39;,
 &#39;t-shirt&#39;,
 &#39;table&#39;,
 &#39;teapot&#39;,
 &#39;teddy-bear&#39;,
 &#39;telephone&#39;,
 &#39;television&#39;,
 &#39;tennis racquet&#39;,
 &#39;tent&#39;,
 &#39;the eiffel tower&#39;,
 &#39;the great wall of china&#39;,
 &#39;the mona lisa&#39;,
 &#39;tiger&#39;,
 &#39;toaster&#39;,
 &#39;toe&#39;,
 &#39;toilet&#39;,
 &#39;tooth&#39;,
 &#39;toothbrush&#39;,
 &#39;toothpaste&#39;,
 &#39;tornado&#39;,
 &#39;tractor&#39;,
 &#39;traffic light&#39;,
 &#39;train&#39;,
 &#39;tree&#39;,
 &#39;triangle&#39;,
 &#39;trombone&#39;,
 &#39;truck&#39;,
 &#39;trumpet&#39;,
 &#39;umbrella&#39;,
 &#39;underwear&#39;,
 &#39;van&#39;,
 &#39;vase&#39;,
 &#39;violin&#39;,
 &#39;washing machine&#39;,
 &#39;watermelon&#39;,
 &#39;waterslide&#39;,
 &#39;whale&#39;,
 &#39;wheel&#39;,
 &#39;windmill&#39;,
 &#39;wine bottle&#39;,
 &#39;wine glass&#39;,
 &#39;wristwatch&#39;,
 &#39;yoga&#39;,
 &#39;zebra&#39;,
 &#39;zigzag&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data_batch</span><span class="p">):</span>
    <span class="n">feature_descriptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ink&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s2">&quot;class_index&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">data_batch</span><span class="p">,</span> <span class="n">feature_descriptions</span><span class="p">)</span>
    <span class="n">flat_sketches</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="s2">&quot;ink&quot;</span><span class="p">])</span>
    <span class="n">sketches</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flat_sketches</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data_batch</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">examples</span><span class="p">[</span><span class="s2">&quot;class_index&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">quickdraw_dataset</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">n_parse_threads</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_read_threads</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span>
                                      <span class="n">num_parallel_reads</span><span class="o">=</span><span class="n">n_read_threads</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">shuffle_buffer_size</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_buffer_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">n_parse_threads</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_set</span> <span class="o">=</span> <span class="n">quickdraw_dataset</span><span class="p">(</span><span class="n">train_files</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">valid_set</span> <span class="o">=</span> <span class="n">quickdraw_dataset</span><span class="p">(</span><span class="n">eval_files</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">quickdraw_dataset</span><span class="p">(</span><span class="n">eval_files</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sketches =&quot;</span><span class="p">,</span> <span class="n">sketches</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lengths =&quot;</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;labels =&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sketches = tf.Tensor(
[[[-0.0944882  -0.04663213  0.        ]
  [-0.08661417  0.04145078  0.        ]
  [-0.03937007  0.05181348  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[ 0.04313726 -0.14960629  0.        ]
  [ 0.06274509 -0.40551183  0.        ]
  [ 0.04313726 -0.12598425  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[ 0.          0.          1.        ]
  [ 0.          0.          0.        ]
  [-0.19607842 -0.03174603  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 ...

 [[-0.12790698  0.01960784  0.        ]
  [-0.02906978  0.2117647   0.        ]
  [-0.04651159  0.06274509  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[ 0.01568628 -0.05357146  0.        ]
  [ 0.10588235 -0.7321428   0.        ]
  [ 0.12941179 -0.07142857  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]

 [[ 0.         -0.23921569  0.        ]
  [ 0.02020203 -0.03921569  0.        ]
  [ 0.11111112 -0.06666667  0.        ]
  ...
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]
  [ 0.          0.          0.        ]]], shape=(32, 94, 3), dtype=float32)
lengths = tf.Tensor(
[49 44 35 94  5 62 25 51 66 29 77 36 19 38 45 17 83 26 20 23 57 31 72 41
 42 38 72 16 23 28 13 37], shape=(32,), dtype=int64)
labels = tf.Tensor(
[116  89  50  24 225  84  43 281 208  60 269  31   6 142   2 240 333 119
 275  53  32  13 305 227  17 186 139 150  67 121 176 103], shape=(32,), dtype=int64)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_sketch</span><span class="p">(</span><span class="n">sketch</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
    <span class="n">sketch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">origin</span><span class="p">,</span> <span class="n">sketch</span><span class="p">]</span>
    <span class="n">stroke_end_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">sketch</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mf">1.</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sketch</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">strokes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">stroke_end_indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Try to guess&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;y:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">strokes</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stroke</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">stroke</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.-&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_sketches</span><span class="p">(</span><span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">n_sketches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sketches</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_sketches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.5</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sketch</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_sketches</span><span class="p">),</span> <span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">draw_sketch</span><span class="p">(</span><span class="n">sketch</span><span class="p">[:</span><span class="n">length</span><span class="p">],</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">draw_sketches</span><span class="p">(</span><span class="n">sketches</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/c1198379aff81b4b5f12ce559f23dba22dfbfc5786a72c5b98854c1634b4a9ad.png" src="../../../_images/c1198379aff81b4b5f12ce559f23dba22dfbfc5786a72c5b98854c1634b4a9ad.png" />
</div>
</div>
<p>Most sketches are composed of less than 100 points:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lengths</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1000</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7f5f08b2464989d08b1a6d6536709d6adce8f0b15589a43cb45b04597c422da2.png" src="../../../_images/7f5f08b2464989d08b1a6d6536709d6adce8f0b15589a43cb45b04597c422da2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">crop_long_sketches</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">inks</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="p">(</span><span class="n">inks</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_length</span><span class="p">],</span> <span class="n">labels</span><span class="p">))</span>

<span class="n">cropped_train_set</span> <span class="o">=</span> <span class="n">crop_long_sketches</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
<span class="n">cropped_valid_set</span> <span class="o">=</span> <span class="n">crop_long_sketches</span><span class="p">(</span><span class="n">valid_set</span><span class="p">)</span>
<span class="n">cropped_test_set</span> <span class="o">=</span> <span class="n">crop_long_sketches</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /home/runner/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/autograph/pyct/static_analysis/liveness.py:83: Analyzer.lamba_check (from tensorflow.python.autograph.pyct.static_analysis.liveness) is deprecated and will be removed after 2023-09-23.
Instructions for updating:
Lambda fuctions will be no more assumed to be used in the statement where they are used, or at least in the same block. https://github.com/tensorflow/tensorflow/issues/56089
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;sparse_categorical_crossentropy&quot;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse_top_k_categorical_accuracy&quot;</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cropped_train_set</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="n">cropped_valid_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/2
  90574/Unknown - 3599s 40ms/step - loss: 4.2718 - accuracy: 0.1443 - sparse_top_k_categorical_accuracy: 0.3333
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">77</span><span class="p">],</span> <span class="n">line</span> <span class="mi">16</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;sparse_categorical_crossentropy&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>               <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>               <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse_top_k_categorical_accuracy&quot;</span><span class="p">])</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cropped_train_set</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>                     <span class="n">validation_data</span><span class="o">=</span><span class="n">cropped_valid_set</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/keras/utils/traceback_utils.py:65,</span> in <span class="ni">filter_traceback.&lt;locals&gt;.error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span> <span class="n">filtered_tb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">65</span>     <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>     <span class="n">filtered_tb</span> <span class="o">=</span> <span class="n">_process_traceback_frames</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/keras/engine/training.py:1650,</span> in <span class="ni">Model.fit</span><span class="nt">(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_batch_size, validation_freq, max_queue_size, workers, use_multiprocessing)</span>
<span class="g g-Whitespace">   </span><span class="mi">1642</span> <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1643</span>     <span class="s2">&quot;train&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1644</span>     <span class="n">epoch_num</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1647</span>     <span class="n">_r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1648</span> <span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1649</span>     <span class="n">callbacks</span><span class="o">.</span><span class="n">on_train_batch_begin</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1650</span>     <span class="n">tmp_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_function</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1651</span>     <span class="k">if</span> <span class="n">data_handler</span><span class="o">.</span><span class="n">should_sync</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1652</span>         <span class="n">context</span><span class="o">.</span><span class="n">async_wait</span><span class="p">()</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/util/traceback_utils.py:150,</span> in <span class="ni">filter_traceback.&lt;locals&gt;.error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span> <span class="n">filtered_tb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">150</span>   <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>   <span class="n">filtered_tb</span> <span class="o">=</span> <span class="n">_process_traceback_frames</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/polymorphic_function/polymorphic_function.py:880,</span> in <span class="ni">Function.__call__</span><span class="nt">(self, *args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">877</span> <span class="n">compiler</span> <span class="o">=</span> <span class="s2">&quot;xla&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jit_compile</span> <span class="k">else</span> <span class="s2">&quot;nonXla&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">879</span> <span class="k">with</span> <span class="n">OptionalXlaContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jit_compile</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">880</span>   <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">882</span> <span class="n">new_tracing_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experimental_get_tracing_count</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">883</span> <span class="n">without_tracing</span> <span class="o">=</span> <span class="p">(</span><span class="n">tracing_count</span> <span class="o">==</span> <span class="n">new_tracing_count</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/polymorphic_function/polymorphic_function.py:912,</span> in <span class="ni">Function._call</span><span class="nt">(self, *args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">909</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">910</span>   <span class="c1"># In this case we have created variables on the first call, so we run the</span>
<span class="g g-Whitespace">    </span><span class="mi">911</span>   <span class="c1"># defunned version which is guaranteed to never create variables.</span>
<span class="ne">--&gt; </span><span class="mi">912</span>   <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_variable_creation_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span>
<span class="g g-Whitespace">    </span><span class="mi">913</span> <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_creation_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span>   <span class="c1"># Release the lock early so that multiple threads can perform the call</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span>   <span class="c1"># in parallel.</span>
<span class="g g-Whitespace">    </span><span class="mi">916</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/polymorphic_function/tracing_compiler.py:134,</span> in <span class="ni">TracingCompiler.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>   <span class="p">(</span><span class="n">concrete_function</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span>    <span class="n">filtered_flat_args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_define_function</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">134</span> <span class="k">return</span> <span class="n">concrete_function</span><span class="o">.</span><span class="n">_call_flat</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>     <span class="n">filtered_flat_args</span><span class="p">,</span> <span class="n">captured_inputs</span><span class="o">=</span><span class="n">concrete_function</span><span class="o">.</span><span class="n">captured_inputs</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/polymorphic_function/monomorphic_function.py:1745,</span> in <span class="ni">ConcreteFunction._call_flat</span><span class="nt">(self, args, captured_inputs, cancellation_manager)</span>
<span class="g g-Whitespace">   </span><span class="mi">1741</span> <span class="n">possible_gradient_type</span> <span class="o">=</span> <span class="n">gradients_util</span><span class="o">.</span><span class="n">PossibleTapeGradientTypes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1742</span> <span class="k">if</span> <span class="p">(</span><span class="n">possible_gradient_type</span> <span class="o">==</span> <span class="n">gradients_util</span><span class="o">.</span><span class="n">POSSIBLE_GRADIENT_TYPES_NONE</span>
<span class="g g-Whitespace">   </span><span class="mi">1743</span>     <span class="ow">and</span> <span class="n">executing_eagerly</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1744</span>   <span class="c1"># No tape is watching; skip to running the function.</span>
<span class="ne">-&gt; </span><span class="mi">1745</span>   <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_call_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inference_function</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1746</span>       <span class="n">ctx</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cancellation_manager</span><span class="o">=</span><span class="n">cancellation_manager</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1747</span> <span class="n">forward_backward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_forward_and_backward_functions</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1748</span>     <span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1749</span>     <span class="n">possible_gradient_type</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1750</span>     <span class="n">executing_eagerly</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1751</span> <span class="n">forward_function</span><span class="p">,</span> <span class="n">args_with_tangents</span> <span class="o">=</span> <span class="n">forward_backward</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/polymorphic_function/monomorphic_function.py:378,</span> in <span class="ni">_EagerDefinedFunction.call</span><span class="nt">(self, ctx, args, cancellation_manager)</span>
<span class="g g-Whitespace">    </span><span class="mi">376</span> <span class="k">with</span> <span class="n">_InterpolateFunctionError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">377</span>   <span class="k">if</span> <span class="n">cancellation_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">378</span>     <span class="n">outputs</span> <span class="o">=</span> <span class="n">execute</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span>         <span class="n">num_outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_outputs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span>         <span class="n">inputs</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>         <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span>         <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span>   <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span>     <span class="n">outputs</span> <span class="o">=</span> <span class="n">execute</span><span class="o">.</span><span class="n">execute_with_cancellation</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">387</span>         <span class="n">num_outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_outputs</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>         <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">391</span>         <span class="n">cancellation_manager</span><span class="o">=</span><span class="n">cancellation_manager</span><span class="p">)</span>

<span class="nn">File ~/work/artificial-intelligence/artificial-intelligence/.venv/lib/python3.10/site-packages/tensorflow/python/eager/execute.py:52,</span> in <span class="ni">quick_execute</span><span class="nt">(op_name, num_outputs, inputs, attrs, ctx, name)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="n">ctx</span><span class="o">.</span><span class="n">ensure_initialized</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="n">tensors</span> <span class="o">=</span> <span class="n">pywrap_tfe</span><span class="o">.</span><span class="n">TFE_Py_Execute</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">_handle</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>                                       <span class="n">inputs</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">num_outputs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="k">except</span> <span class="n">core</span><span class="o">.</span><span class="n">_NotOkStatusException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>   <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">])</span>
<span class="n">y_probas</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">sparse_top_k_categorical_accuracy</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_probas</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6899671
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_new</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">Y_probas</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sketches</span><span class="p">)</span>
<span class="n">top_k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">Y_probas</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_new</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
    <span class="n">draw_sketch</span><span class="p">(</span><span class="n">sketches</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top-5 predictions:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">top_k</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">]]</span>
        <span class="n">proba</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">top_k</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">. </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">proba</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Answer: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3e0a461a0839c63c20bd2117559bb23adbf59ca34e27179b15dc68fd33455eb6.png" src="../../../_images/3e0a461a0839c63c20bd2117559bb23adbf59ca34e27179b15dc68fd33455eb6.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top-5 predictions:
  1. firetruck 46.565%
  2. police car 30.455%
  3. ambulance 3.810%
  4. car 3.695%
  5. cannon 3.371%
Answer: firetruck
Top-5 predictions:
  1. mouth 23.162%
  2. pond 14.151%
  3. pool 12.582%
  4. beard 11.375%
  5. goatee 9.808%
Answer: mouth
Top-5 predictions:
  1. jail 71.532%
  2. fence 6.519%
  3. swing set 5.708%
  4. grass 3.302%
  5. rain 3.023%
Answer: jail
Top-5 predictions:
  1. baseball 79.233%
  2. watermelon 7.687%
  3. basketball 5.259%
  4. clock 1.659%
  5. compass 1.101%
Answer: baseball
Top-5 predictions:
  1. basketball 51.888%
  2. baseball 17.328%
  3. onion 12.688%
  4. watermelon 9.989%
  5. brain 2.216%
Answer: baseball
Top-5 predictions:
  1. lantern 7.235%
  2. toothpaste 6.845%
  3. drill 6.254%
  4. lighthouse 4.624%
  5. crayon 3.566%
Answer: brain
Top-5 predictions:
  1. animal migration 8.771%
  2. blackberry 7.932%
  3. blueberry 6.413%
  4. peas 5.549%
  5. bracelet 3.623%
Answer: helicopter
Top-5 predictions:
  1. vase 42.793%
  2. wine glass 13.744%
  3. shovel 8.136%
  4. house plant 5.144%
  5. sailboat 4.850%
Answer: vase
Top-5 predictions:
  1. anvil 25.870%
  2. drill 9.670%
  3. nail 7.246%
  4. screwdriver 5.611%
  5. knee 4.355%
Answer: anvil
Top-5 predictions:
  1. hurricane 34.674%
  2. tornado 16.056%
  3. blackberry 7.664%
  4. squiggle 5.489%
  5. zigzag 4.906%
Answer: pillow
</pre></div>
</div>
<img alt="../../../_images/9af55031415190cc7f0cf0283dd6ace65ec5cd679a51d80c1a22575b9dda82b5.png" src="../../../_images/9af55031415190cc7f0cf0283dd6ace65ec5cd679a51d80c1a22575b9dda82b5.png" />
<img alt="../../../_images/bbe9753f89ad0929fd7fb373aafaf9a756301c9ca48cc129f4bef05929d4cb95.png" src="../../../_images/bbe9753f89ad0929fd7fb373aafaf9a756301c9ca48cc129f4bef05929d4cb95.png" />
<img alt="../../../_images/6da87afb503149db28a0a783506463cdcac9b3441203927050e014a1c995f27a.png" src="../../../_images/6da87afb503149db28a0a783506463cdcac9b3441203927050e014a1c995f27a.png" />
<img alt="../../../_images/41a826472affdec4425b9aaf707d6217b05b673486af0bbd70746014b1d1febe.png" src="../../../_images/41a826472affdec4425b9aaf707d6217b05b673486af0bbd70746014b1d1febe.png" />
<img alt="../../../_images/5c20fc3958fb6c4bbaea188047f3fe77df6df4b9279a606fde09b19cec1ed0fc.png" src="../../../_images/5c20fc3958fb6c4bbaea188047f3fe77df6df4b9279a606fde09b19cec1ed0fc.png" />
<img alt="../../../_images/19bd351c262a1b421b83bf4231a9ae1f9568874bd2f0c0b5e56c2442d3f30d1b.png" src="../../../_images/19bd351c262a1b421b83bf4231a9ae1f9568874bd2f0c0b5e56c2442d3f30d1b.png" />
<img alt="../../../_images/1afaba8bcc271d48197c47abd7ee12996a19616c885db60d9488e9dd13b7689e.png" src="../../../_images/1afaba8bcc271d48197c47abd7ee12996a19616c885db60d9488e9dd13b7689e.png" />
<img alt="../../../_images/83e8b78283f1a9723bba23762b59eec168f68643d0cbfe34b6b24b712b2fdaaa.png" src="../../../_images/83e8b78283f1a9723bba23762b59eec168f68643d0cbfe34b6b24b712b2fdaaa.png" />
<img alt="../../../_images/bba1ccded665414e234d938386bee2d0f7f51bcb30e6030c8a653269dfa1f127.png" src="../../../_images/bba1ccded665414e234d938386bee2d0f7f51bcb30e6030c8a653269dfa1f127.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;my_sketchrnn&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /Users/ageron/miniconda3/envs/tf2/lib/python3.7/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.
INFO:tensorflow:Assets written to: my_sketchrnn/assets
</pre></div>
</div>
</div>
</div>
</section>
<section id="bach-chorales">
<h2>10. Bach Chorales<a class="headerlink" href="#bach-chorales" title="Permalink to this headline">#</a></h2>
<p><em>Exercise: Download the <a class="reference external" href="https://homl.info/bach">Bach chorales</a> dataset and unzip it. It is composed of 382 chorales composed by Johann Sebastian Bach. Each chorale is 100 to 640 time steps long, and each time step contains 4 integers, where each integer corresponds to a note’s index on a piano (except for the value 0, which means that no note is played). Train a model—recurrent, convolutional, or both—that can predict the next time step (four notes), given a sequence of time steps from a chorale. Then use this model to generate Bach-like music, one note at a time: you can do this by giving the model the start of a chorale and asking it to predict the next time step, then appending these time steps to the input sequence and asking the model for the next note, and so on. Also make sure to check out <a class="reference external" href="https://homl.info/coconet">Google’s Coconet model</a>, which was used for a nice <a class="reference external" href="https://www.google.com/doodles/celebrating-johann-sebastian-bach">Google doodle about Bach</a>.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DOWNLOAD_ROOT</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/ageron/handson-ml2/raw/master/datasets/jsb_chorales/&quot;</span>
<span class="n">FILENAME</span> <span class="o">=</span> <span class="s2">&quot;jsb_chorales.tgz&quot;</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span>
                                <span class="n">DOWNLOAD_ROOT</span> <span class="o">+</span> <span class="n">FILENAME</span><span class="p">,</span>
                                <span class="n">cache_subdir</span><span class="o">=</span><span class="s2">&quot;datasets/jsb_chorales&quot;</span><span class="p">,</span>
                                <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jsb_chorales_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
<span class="n">train_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jsb_chorales_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;train/chorale_*.csv&quot;</span><span class="p">))</span>
<span class="n">valid_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jsb_chorales_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;valid/chorale_*.csv&quot;</span><span class="p">))</span>
<span class="n">test_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jsb_chorales_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;test/chorale_*.csv&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">load_chorales</span><span class="p">(</span><span class="n">filepaths</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">]</span>

<span class="n">train_chorales</span> <span class="o">=</span> <span class="n">load_chorales</span><span class="p">(</span><span class="n">train_files</span><span class="p">)</span>
<span class="n">valid_chorales</span> <span class="o">=</span> <span class="n">load_chorales</span><span class="p">(</span><span class="n">valid_files</span><span class="p">)</span>
<span class="n">test_chorales</span> <span class="o">=</span> <span class="n">load_chorales</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_chorales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[74, 70, 65, 58],
 [74, 70, 65, 58],
 [74, 70, 65, 58],
 [74, 70, 65, 58],
 [75, 70, 58, 55],
 [75, 70, 58, 55],
 [75, 70, 60, 55],
 [75, 70, 60, 55],
 [77, 69, 62, 50],
 [77, 69, 62, 50],
 [77, 69, 62, 50],
 [77, 69, 62, 50],
 [77, 70, 62, 55],
 [77, 70, 62, 55],
 [77, 69, 62, 55],
 [77, 69, 62, 55],
 [75, 67, 63, 48],
 [75, 67, 63, 48],
 [75, 69, 63, 48],
 [75, 69, 63, 48],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [74, 70, 65, 46],
 [75, 69, 63, 48],
 [75, 69, 63, 48],
 [75, 67, 63, 48],
 [75, 67, 63, 48],
 [77, 65, 62, 50],
 [77, 65, 62, 50],
 [77, 65, 60, 50],
 [77, 65, 60, 50],
 [74, 67, 58, 55],
 [74, 67, 58, 55],
 [74, 67, 58, 53],
 [74, 67, 58, 53],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [72, 69, 65, 53],
 [74, 71, 53, 50],
 [74, 71, 53, 50],
 [74, 71, 53, 50],
 [74, 71, 53, 50],
 [75, 72, 55, 48],
 [75, 72, 55, 48],
 [75, 72, 55, 50],
 [75, 72, 55, 50],
 [75, 67, 60, 51],
 [75, 67, 60, 51],
 [75, 67, 60, 53],
 [75, 67, 60, 53],
 [74, 67, 60, 55],
 [74, 67, 60, 55],
 [74, 67, 57, 55],
 [74, 67, 57, 55],
 [74, 65, 59, 43],
 [74, 65, 59, 43],
 [72, 63, 59, 43],
 [72, 63, 59, 43],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [72, 63, 55, 48],
 [75, 67, 60, 60],
 [75, 67, 60, 60],
 [75, 67, 60, 60],
 [75, 67, 60, 60],
 [77, 70, 62, 58],
 [77, 70, 62, 58],
 [77, 70, 62, 56],
 [77, 70, 62, 56],
 [79, 70, 62, 55],
 [79, 70, 62, 55],
 [79, 70, 62, 53],
 [79, 70, 62, 53],
 [79, 70, 63, 51],
 [79, 70, 63, 51],
 [79, 70, 63, 51],
 [79, 70, 63, 51],
 [77, 70, 63, 58],
 [77, 70, 63, 58],
 [77, 70, 60, 58],
 [77, 70, 60, 58],
 [77, 70, 62, 46],
 [77, 70, 62, 46],
 [77, 68, 62, 46],
 [75, 68, 62, 46],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [74, 67, 58, 55],
 [74, 67, 58, 55],
 [74, 67, 58, 55],
 [74, 67, 58, 55],
 [75, 67, 58, 53],
 [75, 67, 58, 53],
 [75, 67, 58, 51],
 [75, 67, 58, 51],
 [77, 65, 58, 50],
 [77, 65, 58, 50],
 [77, 65, 56, 50],
 [77, 65, 56, 50],
 [70, 63, 55, 51],
 [70, 63, 55, 51],
 [70, 63, 55, 51],
 [70, 63, 55, 51],
 [75, 65, 60, 45],
 [75, 65, 60, 45],
 [75, 65, 60, 45],
 [75, 65, 60, 45],
 [74, 65, 58, 46],
 [74, 65, 58, 46],
 [74, 65, 58, 46],
 [74, 65, 58, 46],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [75, 67, 58, 57],
 [75, 67, 58, 57],
 [75, 67, 58, 55],
 [75, 67, 58, 55],
 [77, 65, 60, 57],
 [77, 65, 60, 57],
 [77, 65, 60, 53],
 [77, 65, 60, 53],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [74, 65, 58, 58],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 67, 58, 51],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [72, 65, 57, 53],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46],
 [70, 65, 62, 46]]
</pre></div>
</div>
</div>
</div>
<p>Notes range from 36 (C1 = C on octave 1) to 81 (A5 = A on octave 5), plus 0 for silence:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">notes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">chorales</span> <span class="ow">in</span> <span class="p">(</span><span class="n">train_chorales</span><span class="p">,</span> <span class="n">valid_chorales</span><span class="p">,</span> <span class="n">test_chorales</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">chorale</span> <span class="ow">in</span> <span class="n">chorales</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">chorale</span><span class="p">:</span>
            <span class="n">notes</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span>

<span class="n">n_notes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
<span class="n">min_note</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">notes</span> <span class="o">-</span> <span class="p">{</span><span class="mi">0</span><span class="p">})</span>
<span class="n">max_note</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">min_note</span> <span class="o">==</span> <span class="mi">36</span>
<span class="k">assert</span> <span class="n">max_note</span> <span class="o">==</span> <span class="mi">81</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s write a few functions to listen to these chorales (you don’t need to understand the details here, and in fact there are certainly simpler ways to do this, for example using MIDI players, but I just wanted to have a bit of fun writing a synthesizer):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Audio</span>

<span class="k">def</span> <span class="nf">notes_to_frequencies</span><span class="p">(</span><span class="n">notes</span><span class="p">):</span>
    <span class="c1"># Frequency doubles when you go up one octave; there are 12 semi-tones</span>
    <span class="c1"># per octave; Note A on octave 4 is 440 Hz, and it is note number 69.</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">69</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="mi">440</span>

<span class="k">def</span> <span class="nf">frequencies_to_samples</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">tempo</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">):</span>
    <span class="n">note_duration</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">tempo</span> <span class="c1"># the tempo is measured in beats per minutes</span>
    <span class="c1"># To reduce click sound at every beat, we round the frequencies to try to</span>
    <span class="c1"># get the samples close to zero at the end of each note.</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">note_duration</span> <span class="o">*</span> <span class="n">frequencies</span><span class="p">)</span> <span class="o">/</span> <span class="n">note_duration</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">note_duration</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">note_duration</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">sine_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="p">)</span>
    <span class="c1"># Removing all notes with frequencies ≤ 9 Hz (includes note 0 = silence)</span>
    <span class="n">sine_waves</span> <span class="o">*=</span> <span class="p">(</span><span class="n">frequencies</span> <span class="o">&gt;</span> <span class="mf">9.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sine_waves</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">chords_to_samples</span><span class="p">(</span><span class="n">chords</span><span class="p">,</span> <span class="n">tempo</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">):</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">notes_to_frequencies</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">freqs</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1"># make last note a bit longer</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">frequencies_to_samples</span><span class="p">(</span><span class="n">melody</span><span class="p">,</span> <span class="n">tempo</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">melody</span> <span class="ow">in</span> <span class="n">freqs</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n_fade_out_samples</span> <span class="o">=</span> <span class="n">sample_rate</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">//</span> <span class="n">tempo</span> <span class="c1"># fade out last note</span>
    <span class="n">fade_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">n_fade_out_samples</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">merged</span><span class="p">[</span><span class="o">-</span><span class="n">n_fade_out_samples</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">fade_out</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="k">def</span> <span class="nf">play_chords</span><span class="p">(</span><span class="n">chords</span><span class="p">,</span> <span class="n">tempo</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">44100</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">chords_to_samples</span><span class="p">(</span><span class="n">chords</span><span class="p">,</span> <span class="n">tempo</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">wavfile</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">15</span> <span class="o">*</span> <span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">wavfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">display</span><span class="p">(</span><span class="n">Audio</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">display</span><span class="p">(</span><span class="n">Audio</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s listen to a few chorales:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">play_chords</span><span class="p">(</span><span class="n">train_chorales</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Divine! :)</p>
<p>In order to be able to generate new chorales, we want to train a model that can predict the next chord given all the previous chords. If we naively try to predict the next chord in one shot, predicting all 4 notes at once, we run the risk of getting notes that don’t go very well together (believe me, I tried). It’s much better and simpler to predict one note at a time. So we will need to preprocess every chorale, turning each chord into an arpegio (i.e., a sequence of notes rather than notes played simultaneuously). So each chorale will be a long sequence of notes (rather than chords), and we can just train a model that can predict the next note given all the previous notes. We will use a sequence-to-sequence approach, where we feed a window to the neural net, and it tries to predict that same window shifted one time step into the future.</p>
<p>We will also shift the values so that they range from 0 to 46, where 0 represents silence, and values 1 to 46 represent notes 36 (C1) to 81 (A5).</p>
<p>And we will train the model on windows of 128 notes (i.e., 32 chords).</p>
<p>Since the dataset fits in memory, we could preprocess the chorales in RAM using any Python code we like, but I will demonstrate here how to do all the preprocessing using tf.data (there will be more details about creating windows using tf.data in the next chapter).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_target</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># predict next note in each arpegio, at each step</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span>

<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">window</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">window</span> <span class="o">-</span> <span class="n">min_note</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># shift values</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># convert to arpegio</span>

<span class="k">def</span> <span class="nf">bach_dataset</span><span class="p">(</span><span class="n">chorales</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">window_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">window_shift</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">batch_window</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">window</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_windows</span><span class="p">(</span><span class="n">chorale</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">chorale</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window_shift</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="n">batch_window</span><span class="p">)</span>

    <span class="n">chorales</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ragged</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">chorales</span><span class="p">,</span> <span class="n">ragged_rank</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">chorales</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="n">to_windows</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">shuffle_buffer_size</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_buffer_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s create the training set, the validation set and the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_set</span> <span class="o">=</span> <span class="n">bach_dataset</span><span class="p">(</span><span class="n">train_chorales</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">valid_set</span> <span class="o">=</span> <span class="n">bach_dataset</span><span class="p">(</span><span class="n">valid_chorales</span><span class="p">)</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">bach_dataset</span><span class="p">(</span><span class="n">test_chorales</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s create the model:</p>
<ul class="simple">
<li><p>We could feed the note values directly to the model, as floats, but this would probably not give good results. Indeed, the relationships between notes are not that simple: for example, if you replace a C3 with a C4, the melody will still sound fine, even though these notes are 12 semi-tones apart (i.e., one octave). Conversely, if you replace a C3 with a C#3, it’s very likely that the chord will sound horrible, despite these notes being just next to each other. So we will use an <code class="docutils literal notranslate"><span class="pre">Embedding</span></code> layer to convert each note to a small vector representation (see Chapter 16 for more details on embeddings). We will use 5-dimensional embeddings, so the output of this first layer will have a shape of <code class="docutils literal notranslate"><span class="pre">[batch_size,</span> <span class="pre">window_size,</span> <span class="pre">5]</span></code>.</p></li>
<li><p>We will then feed this data to a small WaveNet-like neural network, composed of a stack of 4 <code class="docutils literal notranslate"><span class="pre">Conv1D</span></code> layers with doubling dilation rates. We will intersperse these layers with <code class="docutils literal notranslate"><span class="pre">BatchNormalization</span></code> layers for faster better convergence.</p></li>
<li><p>Then one <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> layer to try to capture long-term patterns.</p></li>
<li><p>And finally a <code class="docutils literal notranslate"><span class="pre">Dense</span></code> layer to produce the final note probabilities. It will predict one probability for each chorale in the batch, for each time step, and for each possible note (including silence). So the output shape will be <code class="docutils literal notranslate"><span class="pre">[batch_size,</span> <span class="pre">window_size,</span> <span class="pre">47]</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_embedding_dims</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">n_notes</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">n_embedding_dims</span><span class="p">,</span>
                           <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_notes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding (Embedding)        (None, None, 5)           235       
_________________________________________________________________
conv1d (Conv1D)              (None, None, 32)          352       
_________________________________________________________________
batch_normalization (BatchNo (None, None, 32)          128       
_________________________________________________________________
conv1d_1 (Conv1D)            (None, None, 48)          3120      
_________________________________________________________________
batch_normalization_1 (Batch (None, None, 48)          192       
_________________________________________________________________
conv1d_2 (Conv1D)            (None, None, 64)          6208      
_________________________________________________________________
batch_normalization_2 (Batch (None, None, 64)          256       
_________________________________________________________________
conv1d_3 (Conv1D)            (None, None, 96)          12384     
_________________________________________________________________
batch_normalization_3 (Batch (None, None, 96)          384       
_________________________________________________________________
lstm (LSTM)                  (None, None, 256)         361472    
_________________________________________________________________
dense (Dense)                (None, None, 47)          12079     
=================================================================
Total params: 396,810
Trainable params: 396,330
Non-trainable params: 480
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>Now we’re ready to compile and train the model!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;sparse_categorical_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">valid_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
98/98 [==============================] - 17s 171ms/step - loss: 1.8198 - accuracy: 0.5358 - val_loss: 3.7675 - val_accuracy: 0.0428
Epoch 2/20
98/98 [==============================] - 15s 152ms/step - loss: 0.8885 - accuracy: 0.7641 - val_loss: 4.1054 - val_accuracy: 0.0470
Epoch 3/20
98/98 [==============================] - 16s 165ms/step - loss: 0.7471 - accuracy: 0.7930 - val_loss: 3.8600 - val_accuracy: 0.0368
Epoch 4/20
98/98 [==============================] - 16s 165ms/step - loss: 0.6749 - accuracy: 0.8083 - val_loss: 3.0490 - val_accuracy: 0.2196
Epoch 5/20
98/98 [==============================] - 15s 157ms/step - loss: 0.6221 - accuracy: 0.8188 - val_loss: 1.7138 - val_accuracy: 0.5153
Epoch 6/20
98/98 [==============================] - 16s 163ms/step - loss: 0.5833 - accuracy: 0.8283 - val_loss: 1.9068 - val_accuracy: 0.4570
Epoch 7/20
98/98 [==============================] - 16s 165ms/step - loss: 0.5484 - accuracy: 0.8362 - val_loss: 0.7930 - val_accuracy: 0.7678
Epoch 8/20
98/98 [==============================] - 16s 159ms/step - loss: 0.5163 - accuracy: 0.8447 - val_loss: 0.6577 - val_accuracy: 0.8091
Epoch 9/20
98/98 [==============================] - 15s 158ms/step - loss: 0.4877 - accuracy: 0.8519 - val_loss: 0.6239 - val_accuracy: 0.8180
Epoch 10/20
98/98 [==============================] - 17s 171ms/step - loss: 0.4607 - accuracy: 0.8595 - val_loss: 0.6330 - val_accuracy: 0.8151
Epoch 11/20
98/98 [==============================] - 15s 156ms/step - loss: 0.4369 - accuracy: 0.8657 - val_loss: 0.6248 - val_accuracy: 0.8179
Epoch 12/20
98/98 [==============================] - 16s 167ms/step - loss: 0.4125 - accuracy: 0.8726 - val_loss: 0.6046 - val_accuracy: 0.8248
Epoch 13/20
98/98 [==============================] - 16s 162ms/step - loss: 0.3924 - accuracy: 0.8784 - val_loss: 0.6618 - val_accuracy: 0.8096
Epoch 14/20
98/98 [==============================] - 16s 159ms/step - loss: 0.3713 - accuracy: 0.8847 - val_loss: 0.6919 - val_accuracy: 0.8067
Epoch 15/20
98/98 [==============================] - 17s 176ms/step - loss: 0.3562 - accuracy: 0.8889 - val_loss: 0.6123 - val_accuracy: 0.8236
Epoch 16/20
98/98 [==============================] - 16s 165ms/step - loss: 0.3328 - accuracy: 0.8969 - val_loss: 0.6547 - val_accuracy: 0.8133
Epoch 17/20
98/98 [==============================] - 15s 156ms/step - loss: 0.3182 - accuracy: 0.9011 - val_loss: 0.6322 - val_accuracy: 0.8202
Epoch 18/20
98/98 [==============================] - 16s 167ms/step - loss: 0.3007 - accuracy: 0.9069 - val_loss: 0.6929 - val_accuracy: 0.8037
Epoch 19/20
98/98 [==============================] - 16s 168ms/step - loss: 0.2869 - accuracy: 0.9103 - val_loss: 0.6446 - val_accuracy: 0.8220
Epoch 20/20
98/98 [==============================] - 17s 173ms/step - loss: 0.2703 - accuracy: 0.9158 - val_loss: 0.6439 - val_accuracy: 0.8189
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.keras.callbacks.History at 0x7fee205ff490&gt;
</pre></div>
</div>
</div>
</div>
<p>I have not done much hyperparameter search, so feel free to iterate on this model now and try to optimize it. For example, you could try removing the <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> layer and replacing it with <code class="docutils literal notranslate"><span class="pre">Conv1D</span></code> layers. You could also play with the number of layers, the learning rate, the optimizer, and so on.</p>
<p>Once you’re satisfied with the performance of the model on the validation set, you can save it and evaluate it one last time on the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;my_bach_model.h5&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     34/Unknown - 2s 66ms/step - loss: 0.6557 - accuracy: 0.8164
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.6556663916391485, 0.8164004]
</pre></div>
</div>
</div>
</div>
<p><strong>Note:</strong> There’s no real need for a test set in this exercise, since we will perform the final evaluation by just listening to the music produced by the model. So if you want, you can add the test set to the train set, and train the model again, hopefully getting a slightly better model.</p>
<p>Now let’s write a function that will generate a new chorale. We will give it a few seed chords, it will convert them to arpegios (the format expected by the model), and use the model to predict the next note, then the next, and so on. In the end, it will group the notes 4 by 4 to create chords again, and return the resulting chorale.</p>
<p><strong>Warning</strong>: <code class="docutils literal notranslate"><span class="pre">model.predict_classes(X)</span></code> is deprecated. It is replaced with <code class="docutils literal notranslate"><span class="pre">np.argmax(model.predict(X),</span> <span class="pre">axis=-1)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_chorale</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">seed_chords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arpegio</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1">#next_note = model.predict_classes(arpegio)[:1, -1:]</span>
            <span class="n">next_note</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">arpegio</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">arpegio</span><span class="p">,</span> <span class="n">next_note</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arpegio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arpegio</span><span class="p">,</span> <span class="n">arpegio</span> <span class="o">+</span> <span class="n">min_note</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arpegio</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>To test this function, we need some seed chords. Let’s use the first 8 chords of one of the test chorales (it’s actually just 2 different chords, each played 4 times):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_chords</span> <span class="o">=</span> <span class="n">test_chorales</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">play_chords</span><span class="p">(</span><span class="n">seed_chords</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to generate our first chorale! Let’s ask the function to generate 56 more chords, for a total of 64 chords, i.e., 16 bars (assuming 4 chords per bar, i.e., a 4/4 signature):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_chorale</span> <span class="o">=</span> <span class="n">generate_chorale</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="mi">56</span><span class="p">)</span>
<span class="n">play_chords</span><span class="p">(</span><span class="n">new_chorale</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This approach has one major flaw: it is often too conservative. Indeed, the model will not take any risk, it will always choose the note with the highest score, and since repeating the previous note generally sounds good enough, it’s the least risky option, so the algorithm will tend to make notes last longer and longer. Pretty boring. Plus, if you run the model multiple times, it will always generate the same melody.</p>
<p>So let’s spice things up a bit! Instead of always picking the note with the highest score, we will pick the next note randomly, according to the predicted probabilities. For example, if the model predicts a C3 with 75% probability, and a G3 with a 25% probability, then we will pick one of these two notes randomly, with these probabilities. We will also add a <code class="docutils literal notranslate"><span class="pre">temperature</span></code> parameter that will control how “hot” (i.e., daring) we want the system to feel. A high temperature will bring the predicted probabilities closer together, reducing the probability of the likely notes and increasing the probability of the unlikely ones.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_chorale_v2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">seed_chords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arpegio</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">next_note_probas</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">arpegio</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">rescaled_logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">next_note_probas</span><span class="p">)</span> <span class="o">/</span> <span class="n">temperature</span>
            <span class="n">next_note</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">categorical</span><span class="p">(</span><span class="n">rescaled_logits</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">arpegio</span><span class="p">,</span> <span class="n">next_note</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">arpegio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arpegio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arpegio</span><span class="p">,</span> <span class="n">arpegio</span> <span class="o">+</span> <span class="n">min_note</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arpegio</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s generate 3 chorales using this new function: one cold, one medium, and one hot (feel free to experiment with other seeds, lengths and temperatures). The code saves each chorale to a separate file. You can run these cells over an over again until you generate a masterpiece!</p>
<p><strong>Please share your most beautiful generated chorale with me on Twitter &#64;aureliengeron, I would really appreciate it! :))</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_chorale_v2_cold</span> <span class="o">=</span> <span class="n">generate_chorale_v2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">play_chords</span><span class="p">(</span><span class="n">new_chorale_v2_cold</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;bach_cold.wav&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_chorale_v2_medium</span> <span class="o">=</span> <span class="n">generate_chorale_v2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">play_chords</span><span class="p">(</span><span class="n">new_chorale_v2_medium</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;bach_medium.wav&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_chorale_v2_hot</span> <span class="o">=</span> <span class="n">generate_chorale_v2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">seed_chords</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">play_chords</span><span class="p">(</span><span class="n">new_chorale_v2_hot</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;bach_hot.wav&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lastly, you can try a fun social experiment: send your friends a few of your favorite generated chorales, plus the real chorale, and ask them to guess which one is the real one!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">play_chords</span><span class="p">(</span><span class="n">test_chorales</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">64</span><span class="p">],</span> <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;bach_test_4.wav&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "pantelis/artificial-intelligence",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./aiml-common/lectures/rnn"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="lstm/_index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Long Short-Term Memory (LSTM) Cell Architecture</p>
      </div>
    </a>
    <a class="right-next"
       href="../nlp/nlp-intro/_index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Introduction to NLP</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Processing Sequences Using RNN</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-rnns">Basic RNNs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-dataset">Generate the Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-some-baselines">Computing Some Baselines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-simple-rnn">Using a Simple RNN</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnns">Deep RNNs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-several-steps-ahead">Forecasting Several Steps Ahead</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnn-with-batch-norm">Deep RNN with Batch Norm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-rnns-with-layer-norm">Deep RNNs with Layer Norm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-custom-rnn-class">Creating a Custom RNN Class</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#lstms">LSTMs</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#grus">GRUs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-one-dimensional-convolutional-layers-to-process-sequences">Using One-Dimensional Convolutional Layers to Process Sequences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wavenet">WaveNet</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-solutions">Exercise solutions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-8">1. to 8.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tackling-the-sketchrnn-dataset">9. Tackling the SketchRNN Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bach-chorales">10. Bach Chorales</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pantelis Monogioudis, Ph.D
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>